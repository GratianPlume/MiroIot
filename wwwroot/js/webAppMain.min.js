var srAngularApp=angular.module("srAngular",["ngRoute"]).config(function($routeProvider,$iot){$routeProvider.when("/entranceGuardSystem",{templateUrl:"views/entranceGuardSystem.html?"+$iot.startTime,resolve:{auth:function($q,$rootScope){var auth=$rootScope.isAuthorize;return auth?$q.when(auth):$q.reject({authenticated:!1})}}}).when("/querySystem",{templateUrl:"views/querySystem.html?"+$iot.startTime,resolve:{auth:function($q,$rootScope){var auth=$rootScope.isAuthorize;return auth?$q.when(auth):$q.reject({authenticated:!1})}}}).when("/advertisingSystem",{templateUrl:"views/advertisingSystem.html?"+$iot.startTime,resolve:{auth:function($q,$rootScope){var auth=$rootScope.isAuthorize;return auth?$q.when(auth):$q.reject({authenticated:!1})}}}).otherwise({templateUrl:"views/Login.html?"+$iot.startTime})}).run(function($rootScope,$location,$iot){$rootScope.isAuthorize=!1;$rootScope.$on("$routeChangeStart",function(){$rootScope.isAuthorize||$location.path("/")});$rootScope.currentCommunity=!1;$rootScope.openAdsystem=$iot.advertisingMode;try{$iot.connect().bindOpen(function(){return document.title=$iot.title+" - 连接服务器成功"}).bindClose(function(){document.title=$iot.title+" - 与服务器断开连接";alert("连接已断开，请重新登录！");location.reload()}).bindError(function(){return alert($iot.title+"通信发生错误")}).bindClearEvents(function(){$rootScope.$apply(function(){$rootScope.events=[];$rootScope.recordBarData=!0;$rootScope.listQuery=!0})}).bindEvent(function(item){return $rootScope.events.push(item)}).bindEventsCompleted(function(){$rootScope.$apply(function(){$rootScope.recordBarData=!1})}).bindClearLogs(function(){$rootScope.$apply(function(){$rootScope.Status=[];$rootScope.logsbarData=!0;$rootScope.listStatus=!0})}).bindLog(function(item){return $rootScope.Status.push(item)}).bindLogsCompleted(function(){$rootScope.$apply(function(){$rootScope.logsbarData=!1})})}catch(err){typeof err=="string"&&(document.getElementById("message_output").innerHTML=err)}}).filter("relativeText",function(){return function(value){return value?Helper.relativeConstans[value-1].name:""}}).filter("roomName",function($iot){return function(input){var id=$iot.current.id,x=$iot.communities.flatten(id,input);return x?x.block.name+x.unit.name+x.flat.id:input}}).filter("roomToAddressid",function($iot){return function(input){var id=$iot.current.id,x=$iot.communities.flatten(id,input);return x.block.id+x.unit.id+x.flat.id}}).filter("nricFilter",function(){return function(nric){return nric.length>18?"":nric}}).filter("deviceAddress",function(){return Helper.deviceAddressToStr}).filter("nricToname",function(){return function(id,people){if(!id)return"";var x=people.$[id];return x?x.name:""}}).filter("nricTorooms",function(){return function(id,people){if(!id)return[];var x=people.$[id];return x?x.rooms.map(function(y){return y.id}):[]}}).filter("deviceToAddress",function(){return function(device,deviceList){var item=deviceList.$[device];return item?item.address:undefined}}).filter("cardidTonumber",function(){return function(id,number){for(var i=0;i<number.length;i++)if(number[i].id===id)return number[i].serial}}).filter("bindingroomToaddress",function($iot){return function(room){if(!room||room.length!==10)return"";var blockId=room.slice(0,4),block=$iot.current.arch.communityX.items.$[blockId],unitId=room.slice(4,6),unit=block.items.$[unitId],roomId=room.slice(6);return block.name+unit.name+roomId}}).filter("fingerFilter",function(){return function(finger){return finger?Helper.fingerConstans[finger-1].name:""}}).filter("Filter_level",function(){return function(level){return level&63}}).filter("fingerprintToName",function($filter){return function(id,fingerprintList,personelList,fingers){for(var state_1,_loop_1=function(i){if(fingerprintList[i].id===id){var fingerName=fingers.filter(function(t){return t.id===fingerprintList[i].finger});return{value:$filter("nricToname")(fingerprintList[i].nric,personelList)+"的"+fingerName[0].name}}},i=0;i<fingerprintList.length;i++)if(state_1=_loop_1(i),typeof state_1=="object")return state_1.value}}).filter("personFilter",function($filter){return function(viewData,filter){if(!filter)return viewData.personnel.copy.$;var roomPredicate=function(room){return $filter("roomName")(room.id).indexOf(filter)!==-1||$filter("roomToAddressid")(room.id).indexOf(filter)!==-1},predicate=function(item){for(var prop in item)if(item.hasOwnProperty(prop)&&(prop==="rooms"&&item[prop].some(roomPredicate)||item[prop].toString().indexOf(filter)!==-1))return!0;return!1};return viewData.personnel.filter(predicate).$}}).filter("unAuthDevice_filter",function(){return function(deviceList,str){var num=Number(str),zip;return isNaN(num)||!num?deviceList.$:(zip=String(num),deviceList.filter(function(item){return item.address.toString().slice(0,zip.length)===zip}).$)}}).filter("dateFilter",function(){return function(time){var padding=function(num){return("0"+num).slice(-2)},date=new Date(time*1e3),year=date.getFullYear(),month=padding(date.getMonth()+1),day=padding(date.getDate()),hour=padding(date.getHours()),minute=padding(date.getMinutes()),second=padding(date.getSeconds());return year+"/"+month+"/"+day+"  "+hour+":"+minute+":"+second}}).controller("mainCtrl",function($scope,$timeout,$rootScope,$location,$filter,$fp,$iot){function mapToArray(elements,method){return Helper.getSeq(elements).map(method).toArray()}function roomToView(name,value){return{id:value.id,name:name,living:value.living,relative:value.relative,rentalStart:value.rentalStart?new Date(value.rentalStart*1e3):undefined,rentalEnd:value.rentalEnd?new Date(value.rentalEnd*1e3):undefined,uniform:value.uniform}}function roomFromView(value){return{id:value.id,living:value.living,relative:value.relative,rentalStart:Helper.getUnixTimeSeconds(value.rentalStart),rentalEnd:Helper.getUnixTimeSeconds(value.rentalEnd),uniform:value.uniform}}function cleanRoomView(room){return room.relative===10?room.rentalStart&&room.rentalEnd?angular.copy(room):(alert("请选择租赁区间"),undefined):{id:room.id,name:room.name,living:room.living,relative:room.relative,uniform:room.uniform}}function validateCardNumber(cardNumber){var characterArr=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],cardNumberLow=Array.prototype.slice.call(cardNumber.toLowerCase());return cardNumberLow.every(function(t){return characterArr.indexOf(t)!==-1})}function issueSuccess(deviceIdx,secretIdx,devices,secrets){secretIdx===0?$scope.authCompleteinfo.push({device:devices[deviceIdx],success:[secrets[secretIdx]],fail:[]}):$scope.authCompleteinfo[deviceIdx].success.push(secrets[secretIdx])}function issueFail(deviceIdx,secretIdx,devices,secrets,message){deviceIdx===0?$scope.authCompleteinfo.push({device:devices[deviceIdx],success:[],fail:secrets.slice(deviceIdx),message:message}):($scope.authCompleteinfo[deviceIdx].fail.concat(secrets.slice(deviceIdx)),$scope.authCompleteinfo[deviceIdx].message=message)}function issueIgnoreError(deviceIdx,secretIdx,devices,secrets,message){secretIdx===0?$scope.authCompleteinfo.push({device:devices[deviceIdx],success:[],fail:[secrets[secretIdx]],message:message}):$scope.authCompleteinfo[deviceIdx].fail.push(secrets[secretIdx])}function authGenerator(cardList,deviceList,$time,$binding){function auth(deviceIdx,cardIdx){var subData={deviceId:deviceList[deviceIdx],expire:$time,binding:$binding};$iot.cards.issue(cardList[cardIdx],subData).then(function(data){var value=data.errorCode===70000003||data.result;data.result&&$timeout(function(){$scope.communityData.cards.forEach(function(t){t.id===cardList[cardIdx]&&t.auth.push({deviceId:deviceList[deviceIdx],expire:$time,binding:$binding})})});value?issueSuccess(deviceIdx,cardIdx,deviceList,cardList):issueFail(deviceIdx,cardIdx,deviceList,cardList,data.message);deviceIdx===deviceList.length-1&&(value&&cardIdx!==cardList.length-1||$timeout(function(){var selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked"),selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)});$scope.ChooseauthDevice=Helper.complementOfIntersect(selectCardList,$scope.communityData.devices);$scope.alreadyAuth=Helper.unionAuths(selectCardList)}));getNext(value,auth)}).catch(function(err){console.log(err)})}var getNext=Helper.permitGenerator(cardList,deviceList);getNext(!0,auth)}function createFingerprint(){var fp=$fp.create();return fp.onImage=function(index,image){switch(index){case 0:$("#fingerprint1").attr("src",image);break;case 1:$("#fingerprint2").attr("src",image);break;case 2:$("#fingerprint3").attr("src",image)}},fp.onsuccess=function(){$("#FingersInfo").text("采集成功，请保存！").removeClass("text-danger").addClass("text-success")},fp.onfail=function(){$("#FingersInfo").text("采集失败，请重新采集！").removeClass("text-success").addClass("text-danger");$("#fingerprint1").attr("src","images/scanfinger1.png");$("#fingerprint2").attr("src","images/scanfinger2.png");$("#fingerprint3").attr("src","images/scanfinger3.png")},fp.onreset=function(){$scope.websocketIsready?$("#FingersInfo").text("指纹服务连接失败，请查看是否启动服务或重新打开模块！").removeClass("text-success").addClass("text-danger"):$("#FingersInfo").text("指纹服务连接成功!").removeClass("text-danger").addClass("text-success")},fp.onerror=function(){$timeout(function(){$scope.websocketIsready=!0});$("#FingersInfo").text("指纹服务连接失败，请查看是否启动服务或重新打开模块！").removeClass("text-success").addClass("text-danger");$("#fingerprint1").attr("src","images/scanfinger1.png");$("#fingerprint2").attr("src","images/scanfinger2.png");$("#fingerprint3").attr("src","images/scanfinger3.png")},fp.onopen=function(){$timeout(function(){$scope.websocketIsready=!1});$("#FingersInfo").text("指纹服务连接成功！").removeClass("text-danger").addClass("text-success");$("#fingerprint1").attr("src","images/scanfinger1.png");$("#fingerprint2").attr("src","images/scanfinger2.png");$("#fingerprint3").attr("src","images/scanfinger3.png")},fp.onclose=function(){$timeout(function(){$scope.websocketIsready=!0});$("#FingersInfo").text("指纹服务连接失败，请查看是否启动服务或重新打开模块！").removeClass("text-success").addClass("text-danger")},fp}function fingerprintAuthGenerator(fingerprintList,deviceList,$time,$binding){function auth(deviceIdx,fpIdx){var subData={deviceId:deviceList[deviceIdx],expire:$time,binding:$binding};$iot.fingerprints.issue(fingerprintList[fpIdx],subData).then(function(data){var value=data.errorCode===70000003||data.errorCode===24||data.result;data.result&&$timeout(function(){$scope.communityData.Fingerprints.forEach(function(t){t.id===fingerprintList[fpIdx]&&t.auth.push({deviceId:deviceList[deviceIdx],expire:$time,binding:$binding})})});data.errorCode===70000003||data.result?issueSuccess(deviceIdx,fpIdx,deviceList,fingerprintList):data.errorCode===24?issueIgnoreError(deviceIdx,fpIdx,deviceList,fingerprintList,data.message):issueFail(deviceIdx,fpIdx,deviceList,fingerprintList,data.message);deviceIdx===deviceList.length-1&&(value&&fpIdx!==fingerprintList.length-1||$timeout(function(){var selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked"),selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)});$scope.alreadyAuthFingerprint=Helper.unionAuths(selectfingerprintList);$scope.unalreadyAuthFingerprint=Helper.complementOfIntersect(selectfingerprintList,$scope.communityData.devices)}));getNext(value,auth)}).catch(function(err){console.log(err)})}var getNext=Helper.permitGenerator(fingerprintList,deviceList);getNext(!0,auth)}function timeToSeconds(time){var timeStr=String(time),hours=Number(timeStr.substring(0,2)),minutes=Number(timeStr.substring(3));return hours*3600+minutes*60}var urlChoose,sideUrlChoose,sideUrlChooseQuery,sideUrlChooseAdvertising,orderBy,editCommunityData,editedManagerOpenid,treeData,treeComData,blockData,unitData,roomData,refreshOrNo,deletechoosePersonId,choosedeviceId,lastTimeCard,thisTimeCard,fpService,fingeradded,thisTimeFinger,lastTimeFinger,chooseComAdvertising,selectedPlan;$scope.chooseUrl=function(num){$rootScope.currentCommunity=num===1;urlChoose=num};$scope.Urlstyle=function(num){return num===urlChoose?"active":""};$scope.entrancesidebarStyle=function(num){return num===sideUrlChoose?"active":""};$scope.querysidebarStyle=function(num){return num===sideUrlChooseQuery?"active":""};$scope.advertisingsidebarStyle=function(num){return num===sideUrlChooseAdvertising?"active":""};$scope.accountUrl=function(num){return $scope.viewSwitch.mode===num?"active":""};$scope.hideGuardSystem=!1;$scope.hideAdSystem=!1;$scope.hideAdFileManage=!0;$scope.hideAdLaunch=!0;$scope.userGradeList=Helper.adminConstans.slice(0);$scope.showOperateCom=!0;$scope.GradeValue="";$scope.chooseAdPowerView=function(newVal){var parsePower=function(){if($rootScope.openAdsystem){if($scope.adminData.level===0&&Number(newVal)===1)return[!0,!1];if($scope.adminData.level===0||!!($scope.adminData.level&256))return[!1,!0]}return[!1,!1]},_a;_a=parsePower();$scope.chooseAdPower_1=_a[0];$scope.chooseAdPower_2=_a[1]};orderBy=$filter("orderBy");$scope.Login_register=!0;$scope.login=function(user,psw,rmm){$scope.hideGuardSystem=!1;$scope.hideAdSystem=!1;$scope.hideAdFileManage=!0;$scope.hideAdLaunch=!0;$iot.accounts.login(user,psw,rmm).then(function(data){$rootScope.isAuthorize=!0;$timeout(function(){if($scope.chooseNumber=5,$scope.adminData.communities=data.communities,$scope.adminData.name=data.name,$scope.adminData.level=data.level,data.level===0){$location.path("/entranceGuardSystem");urlChoose=1;$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdLaunch=!1;$scope.hideAdFileManage=!1;$scope.showOperateCom=!0;$scope.userGradeList=Helper.adminConstans.slice(0);return}if((data.level&63)==1){if($scope.showOperateCom=!0,$scope.userGradeList=Helper.adminConstans.slice(1),(data.level&256)!=0){$location.path("/entranceGuardSystem");urlChoose=1;$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdLaunch=!1;$scope.hideAdFileManage=!1;return}$location.path("/entranceGuardSystem");urlChoose=1;$scope.hideAdSystem=!1;$scope.hideAdLaunch=!0;$scope.hideAdFileManage=!0;return}if((data.level&63)==2){if($scope.showOperateCom=!1,$scope.userGradeList=Helper.adminConstans.slice(2),(data.level&64)!=0&&(data.level&128)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdLaunch=!1;$scope.hideAdFileManage=!1;$location.path("/entranceGuardSystem");urlChoose=1;return}if((data.level&64)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdFileManage=!1;$scope.hideAdLaunch=!0;$location.path("/entranceGuardSystem");urlChoose=1;return}if((data.level&128)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdFileManage=!0;$scope.hideAdLaunch=!1;$location.path("/entranceGuardSystem");urlChoose=1;return}$location.path("/entranceGuardSystem");urlChoose=1}if((data.level&63)==3){if($scope.userGradeList=[],$scope.hideGuardSystem=!0,(data.level&64)!=0&&(data.level&128)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdLaunch=!1;$scope.hideAdFileManage=!1;$location.path("/querySystem");urlChoose=2;return}if((data.level&64)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdFileManage=!1;$scope.hideAdLaunch=!0;$location.path("/querySystem");urlChoose=2;return}if((data.level&128)!=0){$scope.hideAdSystem=$rootScope.openAdsystem;$scope.hideAdFileManage=!0;$scope.hideAdLaunch=!1;$location.path("/querySystem");urlChoose=2;return}$location.path("/querySystem");urlChoose=2}})}).catch(function(){$("#errorText").removeClass("hidden");$timeout(function(){$("#errorText").addClass("hidden")},3e3)})};$scope.changeLogin=function(){$scope.Login_register=!$scope.Login_register;$("#errorText").text("")};$scope.registerActive=function(user,pwd,code){user&&pwd&&code?$iot.accounts.register(user,pwd,code).then(function(data){if(data.result)$(".badge").text(""),alert("注册成功");else{var errText=data.errors.map(function(x){return x.description}).join("\n");$(".badge").text(errText)}}).catch(function(err){return console.log(err)}):alert("请填写完所有数据！")};$scope.chooseView=function(viewNumber){switch(viewNumber){case 1:sideUrlChoose=1;$scope.chooseNumber=1;return;case 2:sideUrlChoose=2;$scope.chooseNumber=2;return;case 3:sideUrlChoose=3;$scope.chooseNumber=3;$scope.selectedFingerprint=[];$scope.authCompleteinfo=[];return;case 4:sideUrlChoose=4;$scope.selectedCard=[];$scope.chooseNumber=4;$scope.authCompleteinfo=[];return;case 5:sideUrlChoose=5;$scope.addTree=!0;$scope.chooseNumber=5;return;case 6:sideUrlChoose=6;$scope.chooseNumber=6;return;default:sideUrlChoose=5}};$scope.functionalView=function(){switch($scope.chooseNumber){case 1:return"views/entranceGuardView/deviceManagement.html?"+$iot.startTime;case 2:return console.log("PersonnelManagement"),"views/entranceGuardView/PersonnelManagement.html?"+$iot.startTime;case 3:return $("#addFinger").modal({keyboard:!1,backdrop:"static",show:!1}),"views/entranceGuardView/fingerprintManagement.html?"+$iot.startTime;case 4:return"views/entranceGuardView/cardManagement.html?"+$iot.startTime;case 5:return sideUrlChoose=5,"views/entranceGuardView/CommunityStructure.html?"+$iot.startTime;case 6:return"views/entranceGuardView/accountManagement.html?"+$iot.startTime;default:return"views/entranceGuardView/CommunityStructure.html?"+$iot.startTime}};$scope.asideView=!0;$scope.adminData=new AdminView;$scope.getAdminList=function(){$iot.accounts.getSubAdmins().then(function(data){$timeout(function(){$scope.adminData.manager=data})})};$scope.adminViewList=[{control:0,name:"小区列表"},{control:1,name:"管理员列表"},{control:2,name:"生成邀请码"},{control:3,name:"修改密码"}];$scope.viewSwitch={mode:0};$scope.switchView=function(control){$scope.viewSwitch.mode=control};$scope.openEditCommunity=function(community){editCommunityData=community;$("#editCommunity").modal("show");$scope.newCommunityName=community.name;$scope.newCommunityRemark=community.remark};$scope.editCommunity=function(name,remark){if(!name){alert("请填写名称");return}$iot.communities.modify(editCommunityData.id,name,remark).then(function(data){data&&(alert("修改成功！"),$timeout(function(){editCommunityData.name=name;editCommunityData.remark=remark}))}).catch(function(err){console.log(err)})};$scope.deleteCommunity=function(){var deleteCommunityList=angular.element("input:checkbox[name='chooseDeleteCommunity']:checked"),sure=confirm("你确定删除这"+deleteCommunityList.length+"个小区吗？"),deleteCommunityIdList;sure&&(deleteCommunityIdList=mapToArray(deleteCommunityList,function(item){return angular.fromJson(item.value).id}),$iot.communities.delete(deleteCommunityIdList).then(function(){$timeout(function(){$scope.adminData.communities=$scope.adminData.communities.filter(function(item){return deleteCommunityIdList.indexOf(item.id)===-1})});alert("删除成功！")}).catch(function(err){console.log(err)}))};$scope.createNewCommunity=function(area,newCommunityName,newCommunityRemark){if(!area||!newCommunityName||!newCommunityRemark){alert("请填写完所有信息");return}$iot.communities.create(area,newCommunityName,newCommunityRemark).then(function(data){var newCommunityObj={id:data,name:newCommunityName};$timeout(function(){$scope.adminData.communities.unshift(newCommunityObj)});alert("添加成功！")}).catch(function(err){console.log(err)})};$scope.deleteAdmin=function(){var deleteAdminList=angular.element("input:checkbox[name='managerChoose']:checked"),sure=confirm("你确定删除这"+deleteAdminList.length+"个管理员吗？"),deletaAdminOpenidList;sure&&(deletaAdminOpenidList=mapToArray(deleteAdminList,function(x){return x.value}),$iot.accounts.deleteAdmins(deletaAdminOpenidList).then(function(){$timeout(function(){$scope.adminData.manager=$scope.adminData.manager.filter(function(item){return deletaAdminOpenidList.indexOf(item.openid)===-1})});alert("删除成功！")}).catch(function(err){console.log(err)}))};$scope.editAdmin=function(manager){console.log(manager.communities);$("#editAdmin").modal("show");editedManagerOpenid=manager.openid;$scope.editedAdmin=manager.name?manager.name:manager.openid;$scope.editedAdminCommunities=Helper.arrToDic(manager.communities);$scope.uneditedAdminCommunities=$scope.editedAdminCommunities.length===0?Helper.arrToDic(manager.communities):Seq.ofArray($scope.adminData.communities).filter(function(x){return!$scope.editedAdminCommunities.containKey(x.id)}).toDict()};$scope.authCommunity=function(){var authCommunityList=angular.element("input:checkbox[name='unAuthorizedCommunity']:checked"),sure,authCommunityIdList;if(authCommunityList.length===0){alert("请选择小区！");return}(sure=confirm("你确定授权这"+authCommunityList.length+"个小区给该管理员吗？"),sure)&&(authCommunityIdList=mapToArray(authCommunityList,function(x){return x.value}),$iot.accounts.authCommunities(editedManagerOpenid,authCommunityIdList).then(function(){$timeout(function(){var addition=authCommunityIdList.map($scope.uneditedAdminCommunities.tryRemoveKey).filter(function(x){return!!x});$scope.editedAdminCommunities.tryAddHead(function(x){return x.id},addition);$scope.adminData.manager.$[editedManagerOpenid].communities=$scope.editedAdminCommunities.toArray()});alert("授权成功！")}).catch(function(err){console.log(err)}))};$scope.unAuthCommunity=function(){var unauthCommunityList=angular.element("input:checkbox[name='AuthorizedCommunity']:checked"),sure,unauthCommunityIdList;if(unauthCommunityList.length===0){alert("请选择小区！");return}(sure=confirm("你确定删除该管理员这"+unauthCommunityList.length+"个小区的授权吗？"),sure)&&(unauthCommunityIdList=mapToArray(unauthCommunityList,function(x){return x.value}),$iot.accounts.unAuthCommunities(editedManagerOpenid,unauthCommunityIdList).then(function(){$timeout(function(){var addtion=unauthCommunityIdList.map($scope.editedAdminCommunities.tryRemoveKey).filter(function(x){return!!x});$scope.uneditedAdminCommunities.tryAddHead(function(x){return x.id},addtion);$scope.adminData.manager.$[editedManagerOpenid].communities=$scope.editedAdminCommunities.toArray()});alert("删除成功！")}).catch(function(err){console.log(err)}))};$scope.authList=!0;$scope.showList=function(){$scope.authList=!$scope.authList};$scope.generateInviteCode=function(remark){if(!remark){alert("请填写备注，以识别你申请的邀请码!");return}var adPower=angular.element("input:checkbox[name='adPower']:checked"),grade=Number($("#userGrade").val()),level=Helper.getSeq(adPower).fold(grade,function(s,x){return Number(x.value)|s}),inputEle=angular.element("input:checkbox[name='auth']:checked"),authCommunities=mapToArray(inputEle,function(x){return{id:x.value}});$iot.accounts.newInviteCode(level,authCommunities,remark).then(function(data){$("#generate").val(data);$timeout(function(){$scope.adminData.manager.addOrUpdate(data,{level:level,openid:data,remark:remark})})}).catch(function(err){console.log(err)})};$scope.changepwd=function(oldPwd,newPwd){if(!oldPwd||!newPwd){alert("请填写旧密码或者新密码！");return}$iot.manage.changePassword(oldPwd,newPwd).then(function(){alert("密码修改成功")}).catch(function(err){console.log(err)})};$scope.communityData=new MainView;treeData=[];$scope.addTree=!0;$scope.closeaddTree=function(){$scope.addTree=!0};$scope.ComStrViewSwitch={};$scope.drawTree=function(){if(sideUrlChoose===5&&treeData.length!==0){$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}$scope.addTree=!1})}};$scope.SendArch=function(com){com.id&&($rootScope.currentCommunity=!0,$scope.asideView=!1,$iot.communities.loadArch(com.id).then(function(data){if($timeout(function(){$scope.communityData.address=data;$scope.addTree=!0}),data.guid){treeData=Helper.toTreeItem(data);$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}$scope.addTree=!1})}else{treeData=[{text:com.name,id:"0",guid:com.id,nodes:[]}];$("#tree").treeview({data:treeData,levels:2,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":$timeout(function(){$scope.ComStrViewSwitch.mode="0"});treeComData=data;break;case"1":$timeout(function(){$scope.ComStrViewSwitch.mode="1"});blockData=data;break;case"2":$timeout(function(){$scope.ComStrViewSwitch.mode="2"});unitData=data;break;case"3":$timeout(function(){$scope.ComStrViewSwitch.mode="3"});roomData=data}$scope.addTree=!1})}}),$iot.persons.sum(com.id).then(function(data){$timeout(function(){$scope.communityData.personnel=data.copy})}),$iot.devices.items(com.id,function(data){$timeout(function(){$scope.communityData.devices=data;$scope.ChooseauthDevice=data.copy;$scope.unalreadyAuthFingerprint=data.copy})}),$iot.cards.sum(com.id).then(function(data){console.log(data);$timeout(function(){$scope.communityData.cards=data.slice(0);$scope.card_viewData=data.slice(0)})}),$iot.fingerprints.sum(com.id).then(function(data){$timeout(function(){$scope.communityData.Fingerprints=data.slice(0);$scope.fingerprint_viewData=data.slice(0)})}))};$scope.addBuilding=function(id,name){if(!id||!name){alert("请填写完整信息！");return}if(Vadicate.blockId(id)){if(treeData[0].nodes.some(function(item){return item.blockNumber===id})){alert("该楼号重复！！");return}treeData[0].nodes.push({text:id+"--"+name,id:"1",blockNumber:id,blockName:name,nodes:[]});treeData[0].nodes=orderBy(treeData[0].nodes,"blockNumber");$("#tree").treeview({data:treeData,levels:2,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})}};$scope.editBuilding=function(id,name){var _loop_2,i,state_2;if(!id||!name){alert("请填写完整信息");return}if(Vadicate.blockId(id)){for(_loop_2=function(i){if(treeData[0].nodes[i].blockNumber===blockData.blockNumber){var otherFloor=treeData[0].nodes.filter(function(item,index){return index!==i});return otherFloor.some(function(item){return item.blockNumber===id})?(alert("该楼号重复！！"),{value:void 0}):(treeData[0].nodes[i].blockName=name,treeData[0].nodes[i].blockNumber=id,treeData[0].nodes[i].text=id+"--"+name,"break")}},i=0;i<treeData[0].nodes.length;i++){if(state_2=_loop_2(i),typeof state_2=="object")return state_2.value;if(state_2==="break")break}treeData[0].nodes=orderBy(treeData[0].nodes,"blockNumber");$("#tree").treeview({data:treeData,levels:2,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})}};$scope.deleteBuilding=function(){for(var i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockName===blockData.blockNumber){if($scope.communityData.devices.some(function(t){return Helper.deviceAddressToStr(t.address).slice(0,4)===blockData.blockNumber})){alert("请先清除节点下的设备！");return}treeData[0].nodes.splice(i,1);break}$("#tree").treeview({data:treeData,levels:2,multiSelect:!1});$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.editbuildingID="";$scope.ComStrViewSwitch.editbuildingName=""});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})};$scope.addunit=function(unitid,unitname){if(!unitid||!unitname){alert("请填写完整信息！");return}if(Vadicate.unitId(unitid)){for(var i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockNumber===blockData.blockNumber){if(treeData[0].nodes[i].nodes.some(function(item){return item.unitNumber===unitid})){alert("单元号重复！");return}treeData[0].nodes[i].nodes.push({text:unitid+"--"+unitname,id:"2",blockNumber:blockData.blockNumber,unitNumber:unitid,unitName:unitname,nodes:[]});treeData[0].nodes[i].nodes=orderBy(treeData[0].nodes[i].nodes,"unitNumber")}$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})}};$scope.editunit=function(editunitId,editunitName){var i,_loop_3,j,state_3;if(!editunitId||!editunitName){alert("请填写完整信息！");return}if(Vadicate.unitId(editunitId)){for(i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockNumber===unitData.blockNumber){for(_loop_3=function(j){if(treeData[0].nodes[i].nodes[j].unitNumber===unitData.unitNumber){var otherunit=treeData[0].nodes[i].nodes.filter(function(item,index){return index!==j});return otherunit.some(function(item){return item.unitNumber===editunitId})?(alert("单元号重复！"),{value:void 0}):(treeData[0].nodes[i].nodes[j].text=editunitId+"--"+editunitName,treeData[0].nodes[i].nodes[j].unitNumber=editunitId,treeData[0].nodes[i].nodes[j].unitName=editunitName,treeData[0].nodes[i].nodes=orderBy(treeData[0].nodes[i].nodes,"unitNumber"),"break")}},j=0;j<treeData[0].nodes[i].nodes.length;j++){if(state_3=_loop_3(j),typeof state_3=="object")return state_3.value;if(state_3==="break")break}break}$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})}};$scope.deleteunit=function(){var i,j;if($scope.communityData.devices.filter(function(t){return Helper.deviceAddressToStr(t.address).slice(0,4)===unitData.blockNumber}).some(function(t){return Helper.deviceAddressToStr(t.address).slice(4,6)===unitData.unitNumber})){alert("请先清除节点下的设备！");return}for(i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockNumber===unitData.blockNumber){for(j=0;j<treeData[0].nodes[i].nodes.length;j++)if(treeData[0].nodes[i].nodes[j].unitNumber===unitData.unitNumber){treeData[0].nodes[i].nodes.splice(j,1);break}break}$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})};$scope.addroom=function(roomidstart,roomidend,storeyidstart,storeyidend){var fr,rn,id,block,unit_1,addtion;if(!roomidstart||!roomidend||!storeyidstart||!storeyidend){alert("请填写完整信息！");return}if((console.log("roomidstart:"+roomidstart+"\nroomidend:"+roomidend+"\nstoreyidstart:"+storeyidstart+"\nstoreyidend:"+storeyidend),Vadicate.flatId(roomidstart,roomidend))&&Vadicate.flatId(storeyidstart,storeyidend)){var floorStart=Number(storeyidstart),floorEnd=Number(storeyidend),roomStart=Number(roomidstart),roomEnd=Number(roomidend),resultroom=[];for(fr=floorStart;fr<=floorEnd;fr++)for(rn=roomStart;rn<=roomEnd;rn++)id=(fr*100+rn+1e4).toString().slice(-4),resultroom.push(id);block=Helper.findInArray(treeData[0].nodes,function(x){return x.blockNumber===unitData.blockNumber});block&&(unit_1=Helper.findInArray(block.nodes,function(x){return x.unitNumber===unitData.unitNumber}),unit_1&&(addtion=resultroom.filter(function(t){return!unit_1.nodes.some(function(x){return x.roomNumber===t})}).map(function(t){return{text:t,blockNumber:unitData.blockNumber,unitNumber:unitData.unitNumber,roomNumber:t,id:"3",guid:""}}),unit_1.nodes=Helper.sortedMerge(addtion,unit_1.nodes,0,function(a,b){return a.roomNumber.localeCompare(b.roomNumber)})));$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})}};$scope.editroom=function(editroomId){var i,j,n;if(!editroomId){alert("房间号不能为空！");return}if(editroomId.length!==4){alert("房间号格式不对！");return}if(isNaN(Number(editroomId))){alert("房间号格式不对！");return}if(Number(editroomId)<0||Number(editroomId)>9999){alert("房间号格式不对！");return}for(i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockNumber===roomData.blockNumber){for(j=0;j<treeData[0].nodes[i].nodes.length;j++)if(treeData[0].nodes[i].nodes[j].unitNumber===roomData.unitNumber){for(n=0;n<treeData[0].nodes[i].nodes[j].nodes.length;n++)if(treeData[0].nodes[i].nodes[j].nodes[n].roomNumber===roomData.roomNumber){treeData[0].nodes[i].nodes[j].nodes[n].text=editroomId;treeData[0].nodes[i].nodes[j].nodes[n].roomNumber=editroomId;treeData[0].nodes[i].nodes[j].nodes=orderBy(treeData[0].nodes[i].nodes[j].nodes,"roomNumber");break}break}break}$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})};$scope.deleteroom=function(){for(var j,n,i=0;i<treeData[0].nodes.length;i++)if(treeData[0].nodes[i].blockNumber===roomData.blockNumber){for(j=0;j<treeData[0].nodes[i].nodes.length;j++)if(treeData[0].nodes[i].nodes[j].unitNumber===roomData.unitNumber){for(n=0;n<treeData[0].nodes[i].nodes[j].nodes.length;n++)if(treeData[0].nodes[i].nodes[j].nodes[n].roomNumber===roomData.roomNumber){treeData[0].nodes[i].nodes[j].nodes.splice(n,1);$timeout(function(){$scope.ComStrViewSwitch.editroomID=""});break}break}break}$("#tree").treeview({data:treeData,levels:4,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}})};$scope.SubmitComTree=function(){var submitData={name:treeData[0].text,guid:treeData[0].guid,buildings:[]};treeData[0].nodes.forEach(function(flooritem,floorindex){submitData.buildings.push({id:flooritem.blockNumber,name:flooritem.blockName,units:[]});flooritem.nodes.forEach(function(unititem,unitindex){submitData.buildings[floorindex].units.push({id:unititem.unitNumber,name:unititem.unitName,apartments:[]});unititem.nodes.forEach(function(roomitem){submitData.buildings[floorindex].units[unitindex].apartments.push({id:roomitem.roomNumber,guid:roomitem.guid})})})});$iot.communities.updateArch(submitData).then(function(){alert("提交成功");$iot.communities.loadArch(treeData[0].guid).then(function(data){$timeout(function(){$scope.communityData.address=data});treeData=Helper.toTreeItem(data);$("#tree").treeview({data:treeData,levels:3,multiSelect:!1});$("#tree").on("nodeSelected",function(event,data){switch(data.id){case"0":treeComData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="0";$scope.ComStrViewSwitch.buildingID="";$scope.ComStrViewSwitch.buildingName=""});break;case"1":blockData=data;$timeout(function(){$scope.ComStrViewSwitch.editbuildingID=data.blockNumber;$scope.ComStrViewSwitch.editbuildingName=data.blockName;$scope.ComStrViewSwitch.unitID="";$scope.ComStrViewSwitch.unitName="";$scope.ComStrViewSwitch.mode="1"});break;case"2":unitData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="2";$scope.ComStrViewSwitch.editunitID=data.unitNumber;$scope.ComStrViewSwitch.editunitName=data.unitName});break;case"3":roomData=data;$timeout(function(){$scope.ComStrViewSwitch.mode="3";$scope.ComStrViewSwitch.editroomID=data.roomNumber})}$scope.addTree=!1})})}).catch(function(err){console.log(err)})};$scope.editing=!0;$scope.addAddressview=!0;$scope.addAddressList=[];$scope.nationList=Helper.nationList;$scope.pac=Helper.pcaCode;$scope.relativeList=Helper.relativeConstans;$scope.newPerson={rooms:[]};$scope.roomSample={};refreshOrNo=!0;$scope.addAddress=function(building,unit,room){var roomView,roomBinding;if(!building||!unit||!room){alert("请选择完整地址");return}$scope.addAddressList.some(function(item){return item.id===room.guid})||($scope.roomSample.name=building.name+unit.name+room.id,$scope.roomSample.id=room.guid,roomView=cleanRoomView($scope.roomSample),roomView)&&(roomBinding=roomFromView(roomView),$scope.newPerson.rooms.push(roomView),$scope.addAddressList.push(roomBinding),$scope.addAddressview=!1)};$scope.deleteAddAddress=function(id){var deleteIndex;$scope.newPerson.rooms.map(function(item,index){item.id===id&&(deleteIndex=index)});$scope.newPerson.rooms.splice(deleteIndex,1);$scope.addAddressList.splice(deleteIndex,1)};$scope.queryPersonnerl=function(id){if(id.length===18){var validator=new IDValidator;if(!validator.isValid(id)){alert("身份证号码格式不正确！");return}if($scope.communityData.personnel.containKey(id)){alert("身份证号码重复，请查看是否重复添加！");return}$iot.persons.get(id).then(function(data){JSON.stringify(data)!=="{}"&&$timeout(function(){$scope.newPerson={id:id,name:data.name,idAddress:data.address,birthday:new Date(data.birthDay),idValidBegin:new Date(data.validFrom),idValidEnd:new Date(data.validTo),mac:data.phoneMac,nation:data.nation,qq:data.QQ,remark:data.remark,sex:data.sex,tel:data.phone,wechat:data.wechat,workUnit:data.wechat,permanent:data.permanent,kind:data.kind,fluidity:data.fluidity}})})}};$scope.refreshAddAddressList=function(){refreshOrNo&&($scope.addAddressList=[],$scope.newPerson.rooms=[],refreshOrNo=!1)};$scope.addPersonnel=function(person){var validator,addData;if(!person.name){alert("请填写姓名!");return}if($scope.addAddressList.length===0){alert("请添加住址!");return}if(validator=new IDValidator,person.id){if(!validator.isValid(person.id)){alert("身份证号码格式不正确！");return}if($scope.communityData.personnel.containKey(person.id)){alert("身份证号码重复，请查看是否重复添加！");return}}addData={name:person.name,phone:person.tel,nric:person.id,QQ:person.qq,wechat:person.wechat,remark:person.remark,occupation:person.workUnit,phoneMac:person.mac,address:person.idAddress,province:person.province.name,city:person.city.name,district:person.district.name,pcaCode:Number(person.district?person.district.code:person.city?person.city.code:person.province?person.province.code:undefined),domicile:person.domicile,fluidity:person.fluidity,head:(person.head||"").substring(22),headType:"png",kind:person.kind,nation:person.nation,permanent:person.permanent,regCode:person.regCode,sex:person.sex,validFrom:Helper.getUnixTimeSeconds(person.idValidBegin),validTo:Helper.getUnixTimeSeconds(person.idValidEnd),birthDay:Helper.getUnixTimeSeconds(person.birthday),rooms:$scope.addAddressList.slice(0)};console.log(addData);$iot.persons.put(addData).then(function(data){addData.nric=data;$timeout(function(){refreshOrNo=!0;$scope.communityData.personnel.addOrUpdate(data,addData);$scope.alertSuccess=!0;$timeout(function(){$scope.alertSuccess=!1},2e3)})}).catch(function(){$timeout(function(){$scope.alertFail=!0;$timeout(function(){$scope.alertFail=!1},2e3)})})};$scope.choosePersonnel=function(person){function getpcas(){var pcaCode,province,city,district;return person.pcaCode&&(pcaCode=person.pcaCode.toString(),pcaCode.length>=2)?(province=Helper.pacCodeDict.$[pcaCode.substr(0,2)],pcaCode.length>=4)?(city=province.$[pcaCode.substr(0,4)],pcaCode.length===6)?(district=city.$[pcaCode],[province.value,city.value,district]):[province.value,city.value]:[province.value]:[]}console.log("当前选择人员：");console.log(person);$scope.chooseBackColor=person.nric;deletechoosePersonId=person.nric;$scope.choosePersonEdit=person;$scope.editing=person.nric.length===18;console.log(Helper.pacCodeDict);var pcas=getpcas();$scope.curPerson={id:$scope.editing?person.nric:undefined,name:person.name,sex:person.sex,head:person.head?"data:image/png;base64,"+person.head:"",province:pcas[0],city:pcas[1],district:pcas[2],domicile:person.domicile,fluidity:person.fluidity,idAddress:person.address,idValidBegin:new Date(person.validFrom),idValidEnd:new Date(person.validTo),birthday:new Date(person.birthDay),kind:person.kind,mac:person.phoneMac,tel:person.phone,nation:person.nation,qq:person.QQ,wechat:person.wechat,permanent:person.permanent,regCode:person.regCode,remark:person.remark,workUnit:person.occupation,rooms:person.rooms.map(function(x){var name=$filter("roomName")(x.id);return roomToView(name,x)})}};$scope.chooseStyle=function(person){return $scope.chooseBackColor===person.nric?"success":""};$scope.deletePersonnel=function(){if(!deletechoosePersonId){alert("请选择你要删除的人员！");return}var sure=confirm("你确定删除这个人员信息吗？");sure&&$iot.persons.delete(treeData[0].guid,deletechoosePersonId).then(function(){$timeout(function(){$scope.communityData.personnel.tryRemoveKey(deletechoosePersonId)});alert("删除成功！")}).catch(function(err){console.log(err)})};$scope.editAddAddress=function(building,unit,room){if(!building||!unit||!room){alert("请选择完整地址");return}if(!$scope.curPerson.rooms.some(function(item){return item.id===room.guid})){$scope.roomSample.name=building.name+unit.name+room.id;$scope.roomSample.id=room.guid;var roomView=cleanRoomView($scope.roomSample);roomView&&$scope.curPerson.rooms.push(roomView)}};$scope.editDeleteAddAddress=function(id){$scope.curPerson.rooms=$scope.curPerson.rooms.filter(function(x){return x.id!==id})};$scope.editPerson=function(person){var editData,validatoredit,deleteRooms,addRooms;if(!person.name){alert("请填写姓名!");return}if($scope.curPerson.rooms.length===0){alert("请添加住址!");return}if(editData={name:person.name,phone:person.tel,nric:$scope.choosePersonEdit.nric,QQ:person.qq,wechat:person.wechat,remark:person.remark,occupation:person.workUnit,phoneMac:person.mac,address:person.idAddress,province:person.province.name,city:person.city.name,district:person.district.name,pcaCode:Number(person.district?person.district.code:person.city?person.city.code:person.province?person.province.code:undefined),domicile:person.domicile,fluidity:person.fluidity,head:(person.head||"").substring(22)||undefined,headType:"png",kind:person.kind,nation:person.nation,permanent:person.permanent,regCode:person.regCode,sex:person.sex,validFrom:Helper.getUnixTimeSeconds(person.idValidBegin),validTo:Helper.getUnixTimeSeconds(person.idValidEnd),birthDay:Helper.getUnixTimeSeconds(person.birthday),rooms:$scope.addAddressList.slice(0),newNric:$scope.editing?undefined:person.id||undefined},validatoredit=new IDValidator,!$scope.editing&&person.id){if(!validatoredit.isValid(person.id)){alert("身份证号码格式不正确！");return}if($scope.communityData.personnel.containKey(person.id)){alert("身份证号码重复，请查看是否重复添加！");return}}deleteRooms=$scope.choosePersonEdit.rooms.filter(function(item){return!$scope.curPerson.rooms.some(function(x){return x.id===item.id})}).map(function(x){return x.id});addRooms=$scope.curPerson.rooms.map(roomFromView).filter(function(item){return!$scope.choosePersonEdit.rooms.some(function(x){return x.id===item.id})});editData.deleteRooms=deleteRooms;editData.rooms=addRooms;console.log("提交数据：");console.log(editData);$iot.persons.put(editData).then(function(nric){$timeout(function(){var x=$scope.communityData.personnel.import(nric,editData);x&&(x.nric=nric,x.rooms=$scope.curPerson.rooms.map(roomFromView),delete x.deleteRooms);$scope.alertSuccess=!0;$timeout(function(){$scope.alertSuccess=!1},2e3)})}).catch(function(){$timeout(function(){$scope.alertFail=!0;$timeout(function(){$scope.alertFail=!1},2e3)})})};$scope.addDevice=function(addressBuilding,addressUnit,deviceNumber,devicePwd,deviceRemark){var deviceId,addDeviceData;if(!addressBuilding||!addressUnit||deviceNumber.length===0||!devicePwd){alert("请填写设备ID或者设备密码！");return}if(devicePwd.length<6){alert("密码需要大于6位数！");return}if(isNaN(Number(devicePwd))){alert("密码必须为数字");return}if(deviceId=Number(addressBuilding.id+addressUnit.id+deviceNumber),$scope.communityData.devices.some(function(item){return Number(deviceId)===item.address})){alert("该设备地址已经添加！");return}addDeviceData={communityId:$scope.communityData.address.guid,password:devicePwd,address:deviceId,remark:deviceRemark};$iot.devices.put(addDeviceData).then(function(data){$timeout(function(){$scope.communityData.devices.addOrUpdate(data.id,data);$scope.ChooseauthDevice.addOrUpdate(data.id,data);$scope.unalreadyAuthFingerprint.addOrUpdate(data.id,data)});alert("提交成功")}).catch(function(err){console.log(err)})};$scope.chooseDevice=function(device){choosedeviceId=device.address;$scope.choosedeviceGuid=device.id;$scope.newDevicepwd=device.password;$scope.newRemark=device.remark};$scope.chooseDeviceStyle=function(device){return device.address===choosedeviceId?"success":""};$scope.deleteDevice=function(){if(!choosedeviceId){alert("请选择你要删除的设备！");return}var sure=confirm("你确定删除这个设备吗？");sure&&$iot.devices.delete($scope.choosedeviceGuid).then(function(){$timeout(function(){$scope.communityData.devices.tryRemoveKey($scope.choosedeviceGuid);$scope.ChooseauthDevice.tryRemoveKey($scope.choosedeviceGuid);$scope.unalreadyAuthFingerprint.tryRemoveKey($scope.choosedeviceGuid)});alert("删除成功！")}).catch(function(err){console.log(err)})};$scope.editDevicepwd=function(newDevicepwd,newRemark){if(newDevicepwd.length<6){alert("密码需要大于6位数");return}if(isNaN(Number(newDevicepwd))){alert("密码必须为数字");return}var changepwd={id:$scope.choosedeviceGuid,password:newDevicepwd,remark:newRemark};$iot.devices.put(changepwd).then(function(data){data?($timeout(function(){var x=$scope.communityData.devices.$[$scope.choosedeviceGuid];x&&(x.password=newDevicepwd,x.remark=newRemark)}),alert("修改成功")):alert("修改失败")}).catch(function(err){console.log(err)})};$scope.selectAuthDevice=function(){var authDevice=angular.element("input:checkbox[name='chooseAuthDevice']:checked"),authDeviceAddress=mapToArray(authDevice,function(x){var itemValue=angular.fromJson(x.value);return Helper.deviceAddressToStr(itemValue.address)}),getTheFlats;if(authDeviceAddress.length===0){$scope.chooseBinding=!0;$scope.alreadyBinding=!1;return}getTheFlats=function(){var first=authDeviceAddress[0].slice(0,6),i;if(authDeviceAddress.length>1)for(i=1;i<authDeviceAddress.length;i++)if(authDeviceAddress[i].slice(0,10)!==first)return Helper.none();var block=first.slice(0,4),unit=first.slice(4),flats=$iot.current.arch.communityX.items.$[block].items.$[unit].items;return Helper.val(flats)};getTheFlats().data(function(flats){$scope.chooseBinding=!1;$("#alreadyBindingAuth").is(":checked")&&($scope.alreadyBinding=!0);$scope.bindingRoom=flats.toArray(function(x){return{room:x.id,id:authDeviceAddress[0].slice(0,6)+x}})}).none(function(){$scope.chooseBinding=!0;$scope.alreadyBinding=!1;$scope.bindingRoom=[]})};$scope.addCardNumberValidate=!0;$scope.addcardPersonnelsValidate=!0;$scope.addCardcomplete=!0;$scope.chooseBinding=!0;$scope.authCompleteinfo=[];$scope.cardPersonnels=Dict.ofArray(function(t){return t.nric},[]);$scope.cardPersonnel={};$scope.roomPersonnel=function(roomId){if(!roomId){$scope.cardPersonnel={};return}var predicate=function(item){return item.rooms.some(function(x){return x.id===roomId.guid})};$scope.cardPersonnels=$scope.communityData.personnel.filter(predicate);$scope.cardPersonnels.length!==0&&($scope.cardPersonnel.x=$scope.cardPersonnels.first.nric)};$scope.openAddCard=function(){$scope.speedyAddCardSuccessList=[];$("#speedyAddCard_input").val("")};$scope.showSpeedyAddCard=!0;$scope.switchAddCard=function(){$scope.showSpeedyAddCard=!$scope.showSpeedyAddCard;$scope.speedyAddCardSuccessList=[];$("#speedyAddCard_input").val("")};$scope.speedyAddCardInfo=!0;$scope.addCard_speedy=function(event,cardNumber){var keyCode=event.keyCode?event.keyCode:event.which?event.which:event.charCode,addCardData;if(keyCode===13){if(!cardNumber)return;if(!validateCardNumber(cardNumber)){$scope.speedyAddCardInfo=!1;$timeout(function(){$scope.speedyAddCardInfo=!0},2e3);$(".speedyAddNumber").text("卡号不符合规则！");return}if($scope.communityData.cards.some(function(t){return t.serial===cardNumber})){$scope.speedyAddCardInfo=!1;$("#speedyAddCard_input").val("");$(".speedyAddNumber").text("卡号重复！");$timeout(function(){$scope.speedyAddCardInfo=!0},2e3);return}addCardData={communityId:$scope.communityData.address.guid,serial:cardNumber};$iot.cards.put(addCardData).then(function(data){data.id?$timeout(function(){$scope.speedyAddCardSuccessList.unshift(cardNumber);$("#speedyAddCard_input").val("");data.auth=[];$scope.communityData.cards.unshift(data);$scope.card_viewData.unshift(data)}):($(".speedyAddNumber").text("添加失败!"),$timeout(function(){$scope.speedyAddCardInfo=!1;$timeout(function(){$scope.speedyAddCardInfo=!0},2e3)}))}).catch(function(err){console.log(err)})}};$scope.addCard=function(cardNumber,cardPersonnel){if(!cardNumber){$scope.addCardNumberValidate=!1;$timeout(function(){$scope.addCardNumberValidate=!0},3e3);$(".addNumber").text("请填写卡号！");return}if(cardNumber.length<8){$scope.addCardNumberValidate=!1;$timeout(function(){$scope.addCardNumberValidate=!0},3e3);$(".addNumber").text("卡号需要大于8位！");return}if(!validateCardNumber(cardNumber)){$scope.addCardNumberValidate=!1;$timeout(function(){$scope.addCardNumberValidate=!0},3e3);$(".addNumber").text("卡号不符合规则！");return}if($scope.communityData.cards.some(function(t){return t.serial===cardNumber})){$scope.addCardNumberValidate=!1;$timeout(function(){$scope.addCardNumberValidate=!0},3e3);$(".addNumber").text("卡号重复！");return}if(!cardPersonnel){$scope.addcardPersonnelsValidate=!1;$timeout(function(){$scope.addcardPersonnelsValidate=!0},3e3);$(".addCardPersonnels").text("请选择持卡人！");return}var addCardData={communityId:$scope.communityData.address.guid,nric:cardPersonnel,serial:cardNumber};$iot.cards.put(addCardData).then(function(data){data.id?($(".addCardcomplete").text("添加成功"),$timeout(function(){$scope.addCardcomplete=!1;data.auth=[];$scope.communityData.cards.unshift(data);$scope.card_viewData.unshift(data)})):($(".addCardcomplete").text("添加失败，请查看卡号是否重复!"),$timeout(function(){$scope.addCardcomplete=!1}));$timeout(function(){$scope.addCardcomplete=!0},3e3)}).catch(function(err){console.log(err)})};$scope.chooseCard=function(index,event){var $target=$("#"+index),i,selectCard,selectCardList;if(event.shiftKey)if(thisTimeCard=Number(index),lastTimeCard!==undefined){if(thisTimeCard>lastTimeCard)for(i=lastTimeCard;i<=thisTimeCard;i++)$("#"+i).attr("checked",!0),$("#"+i).parent().parent().addClass("bg-success");else for(i=thisTimeCard;i<=lastTimeCard;i++)$("#"+i).attr("checked",!0),$("#"+i).parent().parent().addClass("bg-success");lastTimeCard=Number(index);document.getSelection().empty()}else $target.attr("checked",!0),$target.parent().parent().addClass("bg-success"),lastTimeCard=Number(index);else $target.is(":checked")?($target.attr("checked",!1),$target.parent().parent().removeClass("bg-success"),lastTimeCard=Number(index)):($target.attr("checked",!0),$target.parent().parent().addClass("bg-success"),lastTimeCard=Number(index));selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked");selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)});selectCardList.length===0?($scope.tobe_editCardList=[],$scope.cardEdit_show=!1):selectCardList.every(function(value){return value.auth.length===0})?($scope.tobe_editCardList=selectCardList,$scope.cardEdit_show=!0):($scope.tobe_editCardList=[],$scope.cardEdit_show=!1);$scope.ChooseauthDevice=Helper.complementOfIntersect(selectCardList,$scope.communityData.devices);$scope.alreadyAuth=Helper.unionAuths(selectCardList)};$scope.selectAllCard=function(){var cardAll=$("input:checkbox[name='chooseAuthCard']"),selectCard,selectCardList;cardAll.attr("checked",!0);cardAll.parent().parent().addClass("bg-success");selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked");selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)});selectCardList.every(function(value){return value.auth.length===0})?($scope.tobe_editCardList=selectCardList,$scope.cardEdit_show=!0):($scope.tobe_editCardList=[],$scope.cardEdit_show=!1);$scope.ChooseauthDevice=Helper.complementOfIntersect(selectCardList,$scope.communityData.devices);$scope.alreadyAuth=Helper.unionAuths(selectCardList)};$scope.selectAllCard_not=function(){var cardAll=$("input:checkbox[name='chooseAuthCard']"),selectCard,selectCardList;cardAll.attr("checked",!1);cardAll.parent().parent().removeClass("bg-success");selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked");selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)});$scope.tobe_editCardList=[];$scope.cardEdit_show=!1;$scope.ChooseauthDevice=Helper.complementOfIntersect(selectCardList,$scope.communityData.devices);$scope.alreadyAuth=Helper.unionAuths(selectCardList)};$scope.selectBinding=function(){$scope.alreadyBinding=$("#alreadyBindingAuth").is(":checked")?!0:!1};$scope.cardEdit_show=!1;$scope.editCardcomplete=!0;$scope.tobe_editCardSerial="";$scope.selectCard_Edit=function(){if(console.log($scope.tobe_editCardList),$scope.tobe_editCardList.length===1)if($scope.tobe_editCardList[0].nric){var editCardRooms=$filter("nricTorooms")($scope.tobe_editCardList[0].nric,$scope.communityData.personnel),flat=$iot.communities.flatten($scope.communityData.address.guid,editCardRooms[0]);$scope.editCard_address={building:flat.block,unit:flat.unit,room:flat.flat,nric:$scope.tobe_editCardList[0].nric};$scope.roomPersonnel($scope.editCard_address.room)}else $scope.roomPersonnel(),$scope.editCard_address={};else $scope.roomPersonnel(),$scope.editCard_address={};$scope.tobe_editCardList.forEach(function(value){$scope.tobe_editCardSerial=$scope.tobe_editCardSerial+value.serial+"；"})};$scope.editCard=function(nric){for(var _loop_4=function(i){var editData=$scope.tobe_editCardList[i],cardData={communityId:editData.communityId,id:editData.id,nric:nric,serial:editData.serial};$iot.cards.put(cardData).then(function(data){data.id?($(".editCardcomplete").text(data.serial+"提交成功"),$timeout(function(){var lengthCardCom,lengthCardView,i_1,i_2;for($scope.editCardcomplete=!1,data.auth=[],lengthCardCom=$scope.communityData.cards.length,lengthCardView=$scope.card_viewData.length,i_1=0;i_1<lengthCardCom;i_1++)if($scope.communityData.cards[i_1].id===data.id){$scope.communityData.cards[i_1].nric=data.nric;break}for(i_2=0;i_2<lengthCardView;i_2++)if($scope.card_viewData[i_2].id===data.id){$scope.card_viewData[i_2].nric=data.nric;break}})):($(".editCardcomplete").text(editData.serial+"编辑失败!"),$timeout(function(){$scope.editCardcomplete=!1}));$timeout(function(){$scope.editCardcomplete=!0},2e3)}).catch(function(err){console.log(err)})},i=0;i<$scope.tobe_editCardList.length;i++)_loop_4(i)};$scope.deleteCard=function(){function deleteCardGenerator(carddata){$iot.cards.delete(carddata).then(function(){$timeout(function(){$scope.communityData.cards.forEach(function(item,index){item.id===carddata.id&&$scope.communityData.cards.splice(index,1)});$scope.card_viewData.forEach(function(item,index){item.id===carddata.id&&$scope.card_viewData.splice(index,1)})})}).catch(function(err){console.log(err)})}var selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked"),selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)}),sure,i;if(selectCardList.length!==0&&(sure=confirm("你确定删除这"+selectCardList.length+"张卡吗？"),sure))for(i=0;i<selectCardList.length;i++)if(selectCardList[i].auth.length===0)deleteCardGenerator(selectCardList[i]);else if(sure=confirm("卡号:"+selectCardList[i].serial+"因有授权无法删除！是否继续删除剩余卡？"),!sure)break};$scope.alreadyTime=!1;$scope.validityTimeDefault=function(){if($("#alreadyTimeAuth").is(":checked")){var nowDate=(new Date).format("yyyy-MM-dd")+"T00:00";$("#validityTime").val(nowDate)}};$scope.alreadyBinding=!1;$scope.authCardToDevice=function(){var selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked"),authCardList=Helper.getSeq(selectCard).map(function(x){return angular.fromJson(x.value)}).filter(function(x){return!!x.nric}).map(function(x){return x.id}).toArray(),selectDevice,authDeviceList,$time,$binding,val;if(authCardList.length===0){alert("请选择授权卡");return}if(selectDevice=angular.element("input:checkbox[name='chooseAuthDevice']:checked"),authDeviceList=mapToArray(selectDevice,function(x){return angular.fromJson(x.value).id}),authDeviceList.length===0){alert("请选择设备");return}$("#alreadyTimeAuth").is(":checked")?(val=$("#validityTime").val(),$time=Math.floor(new Date(val).getTime()/1e3)):$time=undefined;$binding=$("#alreadyBindingAuth").is(":checked")&&!$scope.chooseBinding?$("#bindingRoomAddress").val():undefined;$scope.authCompleteinfo=[];authGenerator(authCardList,authDeviceList,$time,$binding)};$scope.deleteAuthCard=function(){function unauthGenerator(cardList,deviceList){function auth(deviceIdx,cardIdx){var subData={deviceId:deviceList[deviceIdx]};$iot.cards.withdraw(cardList[cardIdx],subData).then(function(data){data.result&&$timeout(function(){$scope.communityData.cards.forEach(function(t){t.id===cardList[cardIdx]&&t.auth.forEach(function(t2,index){t2.deviceId===deviceList[deviceIdx]&&t.auth.splice(index,1)})})});data.result?issueSuccess(deviceIdx,cardIdx,deviceList,cardList):issueFail(deviceIdx,cardIdx,deviceList,cardList,data.message);deviceIdx===deviceList.length-1&&(data.result&&cardIdx!==cardList.length-1||$timeout(function(){var selectCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value)});$scope.ChooseauthDevice=Helper.complementOfIntersect(selectCardList,$scope.communityData.devices);$scope.alreadyAuth=Helper.unionAuths(selectCardList)}));getNext(data.result,auth)}).catch(function(err){console.log(err)})}var getNext=Helper.permitGenerator(cardList,deviceList);getNext(!0,auth)}var selectCard=angular.element("input:checkbox[name='chooseAuthCard']:checked"),authCardList=mapToArray(selectCard,function(x){return angular.fromJson(x.value).id}),unAuthDevice,unAuthDeviceList;if(authCardList.length===0){alert("请选择卡");return}unAuthDevice=angular.element("input:checkbox[name='chooseAlreadyAuth']:checked");unAuthDeviceList=mapToArray(unAuthDevice,function(x){return angular.fromJson(x.value).deviceId});$scope.authCompleteinfo=[];unauthGenerator(authCardList,unAuthDeviceList)};$scope.cardFilter=function(str){$scope.card_viewData=str?$scope.communityData.cards.filter(function(item){for(var prop in item)if(item.hasOwnProperty(prop))if(prop==="serial"){if(item[prop].indexOf(str)!==-1)return!0}else if(prop==="nric"&&(item[prop].indexOf(str)!==-1||$filter("nricToname")(item[prop],$scope.communityData.personnel).indexOf(str)!==-1))return!0;return!1}):$scope.communityData.cards.slice(0)};$scope.chooseFingersInfoHide=!0;$scope.FingerConstans=Helper.fingerConstans;fingeradded=[];$scope.chooseFingerConstans=function(finger){$scope.chooseFingersInfoHide=fingeradded.some(function(t){return t.finger===Number(finger)})?!1:!0;fpService.reset();$("#fingerprint1").attr("src","images/scanfinger1.png");$("#fingerprint2").attr("src","images/scanfinger2.png");$("#fingerprint3").attr("src","images/scanfinger3.png")};$scope.getUserFingerprints=function(user){user&&$iot.fingerprints.get(JSON.parse(user).nric).then(function(data){fingeradded=data;console.log(data);console.log($scope.communityData.Fingerprints)})};$scope.chooseFinger=function(finger){return finger?fingeradded.some(function(t){return t.finger===finger.id})?"text-success":"text-danger":finger};$scope.openAddFinger=function(){fpService=fpService||createFingerprint();$("#addFinger").modal("show")};$scope.resetFinger=function(){fpService.reset();$("#fingerprint1").attr("src","images/scanfinger1.png");$("#fingerprint2").attr("src","images/scanfinger2.png");$("#fingerprint3").attr("src","images/scanfinger3.png")};$scope.closeAddFinger=function(){$("#addFinger").modal("hide");fpService.close();fpService=undefined};$scope.addFinger=function(finger,user){var subData_1,i,subData;if(!finger){alert("请选择手指");return}if(!user){alert("请选择用户！");return}if(fpService.item)subData=fpService.item,subData.communityId=$scope.communityData.address.guid,subData.nric=JSON.parse(user).nric,subData.finger=Number(finger),$iot.fingerprints.put(subData).then(function(data){var haveuser,havefinger_1;$("#FingersInfo").text("保存成功").removeClass("text-danger").addClass("text-success");data.auth=[];$timeout(function(){$scope.resetFinger()},1e3);haveuser=$scope.communityData.Fingerprints.filter(function(item){return item.nric===data.nric});haveuser.length===0?$timeout(function(){$scope.communityData.Fingerprints.unshift(data);$scope.fingerprint_viewData.unshift(data)}):(havefinger_1=haveuser.filter(function(item){return item.finger===data.finger}),havefinger_1.length===0?$timeout(function(){$scope.communityData.Fingerprints.push(data);$scope.fingerprint_viewData.push(data)}):$timeout(function(){console.log($scope.communityData.Fingerprints);console.log($scope.fingerprint_viewData);havefinger_1[0].id=data.id;console.log($scope.communityData.Fingerprints);console.log($scope.fingerprint_viewData)}))}).catch(function(err){console.log(err)});else if(fingeradded.some(function(t){return t.finger===Number(finger)})){for(subData_1={communityId:$scope.communityData.address.guid},i=0;i<fingeradded.length;i++)if(fingeradded[i].finger===Number(finger)){subData_1.id=fingeradded[i].id;break}$scope.communityData.Fingerprints.some(function(t){return t.id===subData_1.id})?($("#FingersInfo").text("已经绑定该小区").removeClass("text-danger").addClass("text-success"),$timeout(function(){$scope.resetFinger()},1e3)):$iot.fingerprints.bind(subData_1).then(function(data){if(data){$("#FingersInfo").text("保存成功").removeClass("text-danger").addClass("text-success");var addData_1={auth:[],finger:Number(finger),id:subData_1.id,nric:JSON.parse(user).nric};$timeout(function(){$scope.resetFinger()},1e3);$timeout(function(){$scope.communityData.Fingerprints.unshift(addData_1);$scope.fingerprint_viewData.unshift(addData_1)})}else $("#FingersInfo").text("保存失败").removeClass("text-success").addClass("text-danger")}).catch(function(err){console.log(err)})}else{alert("请采集指纹");return}};$scope.chooseFingerprint=function(index,event){var $target=$("#"+index),i,selectfingerprint,selectfingerprintList;if(event.shiftKey)if(thisTimeFinger=Number(index),lastTimeFinger!==undefined){if(thisTimeFinger>lastTimeFinger)for(i=lastTimeFinger;i<=thisTimeFinger;i++)$("#"+i).attr("checked",!0),$("#"+i).parent().parent().addClass("bg-success");else for(i=thisTimeFinger;i<=lastTimeFinger;i++)$("#"+i).attr("checked",!0),$("#"+i).parent().parent().addClass("bg-success");lastTimeFinger=Number(index);document.getSelection().empty()}else $target.attr("checked",!0),$target.parent().parent().addClass("bg-success"),lastTimeFinger=Number(index);else $target.is(":checked")?($target.attr("checked",!1),$target.parent().parent().removeClass("bg-success"),lastTimeFinger=Number(index)):($target.attr("checked",!0),$target.parent().parent().addClass("bg-success"),lastTimeFinger=Number(index));selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked");selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)});$scope.alreadyAuthFingerprint=Helper.unionAuths(selectfingerprintList);$scope.unalreadyAuthFingerprint=Helper.complementOfIntersect(selectfingerprintList,$scope.communityData.devices)};$scope.selectAllFingerprint=function(){var cardAll=$("input:checkbox[name='chooseAuthFingerprint']"),selectfingerprint,selectfingerprintList;cardAll.attr("checked",!0);cardAll.parent().parent().addClass("bg-success");selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked");selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)});$scope.alreadyAuthFingerprint=Helper.unionAuths(selectfingerprintList);$scope.unalreadyAuthFingerprint=Helper.complementOfIntersect(selectfingerprintList,$scope.communityData.devices)};$scope.selectAllfingerprint_not=function(){var cardAll=$("input:checkbox[name='chooseAuthFingerprint']"),selectfingerprint,selectfingerprintList;cardAll.attr("checked",!1);cardAll.parent().parent().removeClass("bg-success");selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked");selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)});$scope.alreadyAuthFingerprint=Helper.unionAuths(selectfingerprintList);$scope.unalreadyAuthFingerprint=Helper.complementOfIntersect(selectfingerprintList,$scope.communityData.devices)};$scope.deletefingerprint=function(){function deleteFingerprintGenerator(fingerprintdata){var deleteData={communityId:$scope.communityData.address.guid,id:fingerprintdata.id};$iot.fingerprints.delete(deleteData).then(function(){$timeout(function(){$scope.communityData.Fingerprints.forEach(function(item,index){item.id===fingerprintdata.id&&$scope.communityData.Fingerprints.splice(index,1)});$scope.fingerprint_viewData.forEach(function(item,index){item.id===fingerprintdata.id&&$scope.fingerprint_viewData.splice(index,1)})})}).catch(function(err){console.log(err)})}var selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked"),selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)}),i,name_1,finger;if(selectfingerprintList.length!==0&&confirm("你确定删除这"+selectfingerprintList.length+"个指纹吗？"))for(i=0;i<selectfingerprintList.length;i++)if(selectfingerprintList[i].auth.length===0)deleteFingerprintGenerator(selectfingerprintList[i]);else if(name_1=$filter("nricToname")(selectfingerprintList[i].nric,$scope.communityData.personnel),finger=$filter("fingerFilter")(selectfingerprintList[i].finger),!confirm("指纹:"+name_1+finger+"的指纹已授权，无法删除！是否继续删除剩余指纹？"))break};$scope.authFingerprintToDevice=function(){var selectFingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked"),authFingerprintList=mapToArray(selectFingerprint,function(x){return angular.fromJson(x.value)}),selectDevice,authDeviceList,$time,$binding;if(authFingerprintList.length===0){alert("请选择授权指纹");return}if(selectDevice=angular.element("input:checkbox[name='chooseAuthDevice']:checked"),authDeviceList=mapToArray(selectDevice,function(x){return angular.fromJson(x.value).id}),authDeviceList.length===0){alert("请选择设备");return}$time=$("#alreadyTimeAuth").is(":checked")?new Date($("#validityTime").val()).getTime()/1e3:undefined;$binding=$("#alreadyBindingAuth").is(":checked")&&!$scope.chooseBinding?$("#bindingRoomAddress").val():undefined;$scope.authCompleteinfo=[];fingerprintAuthGenerator(authFingerprintList,authDeviceList,$time,$binding)};$scope.deleteAuthfingerprint=function(){function unauthGenerator(fingerprintList,deviceList){function auth(deviceIdx,fpIdx){var subData={deviceId:deviceList[deviceIdx]};$iot.fingerprints.withdraw(fingerprintList[fpIdx],subData).then(function(data){var value=data.errorCode===70000003||data.result;data.result&&$timeout(function(){$scope.communityData.Fingerprints.forEach(function(t){t.id===fingerprintList[fpIdx]&&t.auth.forEach(function(t2,index){t2.deviceId===deviceList[deviceIdx]&&t.auth.splice(index,1)})})});value?issueSuccess(deviceIdx,fpIdx,deviceList,fingerprintList):issueFail(deviceIdx,fpIdx,deviceList,fingerprintList,data.message);deviceIdx===deviceList.length-1&&(data.result&&fpIdx!==fingerprintList.length-1||$timeout(function(){var selectfingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked"),selectfingerprintList=mapToArray(selectfingerprint,function(x){return angular.fromJson(x.value)});$scope.alreadyAuthFingerprint=Helper.unionAuths(selectfingerprintList);$scope.unalreadyAuthFingerprint=Helper.complementOfIntersect(selectfingerprintList,$scope.communityData.devices)}));getNext(value,auth)}).catch(function(err){console.log(err)})}var getNext=Helper.permitGenerator(fingerprintList,deviceList);getNext(!0,auth)}var selectFingerprint=angular.element("input:checkbox[name='chooseAuthFingerprint']:checked"),authFingerprintList=mapToArray(selectFingerprint,function(x){return angular.fromJson(x.value).id}),unAuthDevice=angular.element("input:checkbox[name='chooseAlreadyAuth']:checked"),unAuthDeviceList=mapToArray(unAuthDevice,function(x){return angular.fromJson(x.value).deviceId});authFingerprintList.length!==0&&unAuthDeviceList.length!==0&&($scope.authCompleteinfo=[],unauthGenerator(authFingerprintList,unAuthDeviceList))};$scope.fingerprintFilter=function(str){if(!str){$scope.fingerprint_viewData=$scope.communityData.Fingerprints.slice(0);return}var filterData=[];$scope.communityData.Fingerprints.forEach(function(item){for(var prop in item)if(item.hasOwnProperty(prop)&&prop==="nric")if(item[prop].indexOf(str)!==-1){filterData.push(item);break}else if($filter("nricToname")(item[prop],$scope.communityData.personnel).indexOf(str)!==-1){filterData.push(item);break}});$scope.fingerprint_viewData=filterData};$scope.chooseadvertisingView=function(viewNumber){switch(viewNumber){case 1:sideUrlChooseAdvertising=1;$scope.selectedAdView=1;return;case 2:sideUrlChooseAdvertising=2;$scope.selectedAdView=2;return}};$scope.functionaladvertisingView=function(){switch($scope.selectedAdView){case 1:$("#uploadFile").on("show.bs.collapse",function(){$("#selectedPlayCom").multiselect()});return"views/AdvertisingView/fileManagement.html";case 2:return"views/AdvertisingView/advertisingLaunch.html";default:if(!$scope.hideAdFileManage)return sideUrlChooseAdvertising=1,"views/AdvertisingView/fileManagement.html";if(!$scope.hideAdLaunch)return sideUrlChooseAdvertising=2,"views/AdvertisingView/advertisingLaunch.html"}};$scope.getAdminAdvertisingFile=function(){$iot.advertising.files.sum().then(function(data){$timeout(function(){console.log(data);$scope.adminData.Advertising=data})})};$scope.upAdvertisingFile=function(){var upForm=$("#upFileForm"),formData=new FormData(upForm[0]),type=formData.get("File").type,size=formData.get("File").size;if(console.log(type),console.log(size),size>3e7){alert("文件过大,不能超过28M");return}if(type!=="video/mp4"&&type!=="video/flv"){alert("只允许上传mp4或者flv视频");return}type==="video/mp4"&&formData.set("DataType","1");type==="video/flv"&&formData.set("DataType","2");$iot.advertising.files.post(formData).then(function(id){$timeout(function(){$scope.adminData.Advertising.push({title:String(formData.get("Title")),id:id,remark:String(formData.get("Remark")),communities:formData.getAll("Communities").map(String)})})})};$scope.open_EditFile=function(file){$scope.whoFile=JSON.parse(JSON.stringify(file));$("#editPlayCom").multiselect();$("#editFile").modal("show")};$scope.editFile=function(){var upForm=$("#editFileForm"),formData=new FormData(upForm[0]),reqData={id:$scope.whoFile.id,title:formData.get("Title"),remark:formData.get("Remark"),communities:formData.getAll("Communities")};console.log(reqData);$iot.advertising.files.put(reqData).then(function(){})};$scope.getComPlans=function(com){$scope.authADCompleteinfo=[];$iot.advertising.plans.get(com).then(function(data){$timeout(function(){console.log(data);$scope.communityData.AdvertisingPlans=data})});$iot.devices.items(com,function(data){$timeout(function(){$scope.communityData.ADunAuthDevice=data.copy;$scope.ChooseauthDevice_AD=Dict.zero();$scope.alreadyAuth_AD=Dict.zero()})})};$scope.getcomAdFile=function(com){chooseComAdvertising=com;$iot.advertising.files.get(com).then(function(data){$timeout(function(){$scope.communityData.AdFiles=data})})};$scope.addPlayTimeForm=function(){$("#addplayTime").append('<form class="form-inline addplayform">\n                            <div class="form-group form-group-sm">\n                                <label>播放区间：<\/label>\n                                <input type="time" name="StartTime" class="form-control">--\n                                <input type="time" name="EndTime" class="form-control">\n                            <\/div>\n                            <div class="form-group form-group-sm">\n                                <label>星期：<\/label>\n                                <select class="form-control playWeek" multiple="multiple" name="WeekDays">\n                                    <option value="0">星期日<\/option>\n                                    <option value="1">星期一<\/option>\n                                    <option value="2">星期二<\/option>\n                                    <option value="3">星期三<\/option>\n                                    <option value="4">星期四<\/option>\n                                    <option value="5">星期五<\/option>\n                                    <option value="6">星期六<\/option>\n                                <\/select>\n                            <\/div>\n                            <div class="form-group form-group-sm">\n                                <label>循环：<\/label>\n                                <label class="radio-inline">\n                                    <input type="radio" name="Loop" value="true" checked> 是\n                                <\/label>\n                                <label class="radio-inline">\n                                    <input type="radio" name="Loop" value="false"> 否\n                                <\/label>\n                            <\/div>\n                            <button type="button" class="btn btn-default btn-sm" onclick=\'removeSelf(event)\'>删除<\/button>\n                        <\/form>');$(".playWeek").multiselect({buttonContainer:'<div class="btn-group btn-group-sm" />'})};$scope.secondsTotime=function(secondStr){var second=Number(secondStr),hour=("0"+(second/3600|0)).slice(-2),minute=("0"+(second%3600/60|0)).slice(-2);return hour+":"+minute};$scope.weekDayToStr=function(weekDays){var list,str,week,i;if(weekDays.length===0)return"星期";for(list=[],week=Helper.weekConstans,i=0;i<weekDays.length;i++)list.push(week[weekDays[i]]);return str=list.join("、"),"星期"+str};$scope.addPlaybackPlan=function(){var playbackPlanData={fileId:"",remark:"",plans:[]},playbackPlan=$("#playbackPlanForm"),playbackPlanFormData=new FormData(playbackPlan[0]),playForms,i,formData,termTimestamp,today;if(!playbackPlanFormData.get("FileId")){alert("请选择文件！");return}if(!playbackPlanFormData.get("Remark")){alert("请填写备注！");return}if(!playbackPlanFormData.get("Term")){alert("请填写终止时间！");return}if(playForms=$(".addplayform"),playForms.length===0){alert("请添加时段");return}for(i=0;i<playForms.length;i++){if(formData=new FormData(playForms[i]),!formData.get("StartTime")){alert("有时段开始时间没有正确填写！");return}if(!formData.get("EndTime")){alert("有时段结束时间没有正确填写！");return}if(timeToSeconds(formData.get("StartTime"))>=timeToSeconds(formData.get("EndTime"))){alert("有时段结束时间没有大于开始时间！");return}if(formData.getAll("WeekDays").length===0){alert("有时段的星期没有选择");return}formData.set("StartTime",String(timeToSeconds(formData.get("StartTime"))));formData.set("EndTime",String(timeToSeconds(formData.get("EndTime"))));playbackPlanData.plans.push({startTime:Number(formData.get("StartTime")),endTime:Number(formData.get("EndTime")),weekDays:formData.getAll("WeekDays").map(Number),loop:!!formData.get("Loop")})}if(playbackPlanData.fileId=playbackPlanFormData.get("FileId"),termTimestamp=new Date(Number(playbackPlanFormData.get("Term"))).getTime()/1e3,today=(new Date).getTime()/1e3,termTimestamp<=today){alert("终止时间需要大于今天！");return}playbackPlanData.term=termTimestamp;playbackPlanData.remark=playbackPlanFormData.get("Remark");$iot.advertising.plans.post(chooseComAdvertising,playbackPlanData).then(function(){alert("上传成功！");$iot.advertising.plans.get(chooseComAdvertising).then(function(data){$timeout(function(){console.log(data);$scope.communityData.AdvertisingPlans=data})})}).catch(function(err){console.log(err)})};$scope.deletePlaybackPlan=function(){selectedPlan&&(console.log(selectedPlan),$iot.advertising.plans.delete(selectedPlan).then(function(x){console.log(x);x.result?$iot.advertising.plans.get(chooseComAdvertising).then(function(data){$timeout(function(){console.log(data);$scope.communityData.AdvertisingPlans=data})}):alert("删除失败！"+x.message)}).catch(function(err){console.log(err)}))};$scope.choosePlan=function(plan){selectedPlan=plan.id;$iot.advertising.devices.get(selectedPlan).then(function(data){$timeout(function(){$scope.ChooseauthDevice_AD=$scope.communityData.ADunAuthDevice.filter(function(item){return data.indexOf(item.id)===-1});$scope.alreadyAuth_AD=$scope.communityData.ADunAuthDevice.filter(function(item){return data.indexOf(item.id)!==-1})})})};$scope.choosePlanStyle=function(item){return item.id===selectedPlan?"success":""};$scope.authAdPlayToDevice=function(){var selectDevice,selectDeviceList,i;if($scope.authADCompleteinfo=[],selectDevice=angular.element("input:checkbox[name='chooseAuthDevice_AD']:checked"),selectDeviceList=mapToArray(selectDevice,function(x){return angular.fromJson(x.value).id}),selectDeviceList.length!==0)for(i=0;i<selectDeviceList.length;i++)(function(i){var issue={deviceId:selectDeviceList[i],planId:selectedPlan};$iot.advertising.issue.post(issue).then(function(data){$timeout(function(){if(data.result){var successDevice=$scope.communityData.ADunAuthDevice.$[selectDeviceList[i]];$scope.alreadyAuth_AD.addOrUpdate(successDevice.id,successDevice);$scope.ChooseauthDevice_AD=$scope.ChooseauthDevice_AD.filter(function(item){return item.id!==selectDeviceList[i]})}data.device=selectDeviceList[i];$scope.authADCompleteinfo.push(data)});console.log(data)}).catch(function(err){console.log(err)})})(i)};$scope.deleteAuth_AD=function(){var selectDevice,selectDeviceList,i;if($scope.authADCompleteinfo=[],selectDevice=angular.element("input:checkbox[name='chooseAlreadyAuth_AD']:checked"),selectDeviceList=mapToArray(selectDevice,function(x){return angular.fromJson(x.value).id}),selectDeviceList.length!==0)for(i=0;i<selectDeviceList.length;i++)(function(i){var issue={deviceId:selectDeviceList[i],planId:selectedPlan};$iot.advertising.issue.post(issue).then(function(data){$timeout(function(){if(data.result){var successDevice=$scope.communityData.ADunAuthDevice.$[selectDeviceList[i]];$scope.ChooseauthDevice_AD.addOrUpdate(successDevice.id,successDevice);$scope.alreadyAuth_AD=$scope.alreadyAuth_AD.filter(function(item){return item.id!==selectDeviceList[i]})}data.device=selectDeviceList[i];$scope.authADCompleteinfo.push(data)});console.log(data)}).catch(function(err){console.log(err)})})(i)};$scope.moreQuery="更多选项";$scope.openMore=!1;$scope.openMoreChange=function(){$scope.openMore?($scope.openMore=!1,$scope.moreQuery="更多选项"):($scope.openMore=!0,$scope.moreQuery="关闭更多")};$scope.chooseQueryView=function(viewNumber){switch(viewNumber){case 1:sideUrlChooseQuery=1;$scope.selectedView=1;return;case 2:sideUrlChooseQuery=2;$scope.selectedView=2;return}};$scope.functionalQueryView=function(){switch($scope.selectedView){case 1:return"views/QueryView/record.html?"+$iot.startTime;case 2:return"views/QueryView/DeviceStatus.html?"+$iot.startTime;default:return sideUrlChooseQuery=1,"views/QueryView/record.html?"+$iot.startTime}};$scope.searchData={GateList:[]};$scope.eventlist=Helper.eventConstans;$scope.event=$scope.eventlist[0].id;$scope.initTime=function(){$("#startTime").val((new Date).format("yyyy-MM-dd")+" 00:00:00");$("#endTime").val((new Date).format("yyyy-MM-dd")+" 23:59:59")};$scope.getGate=function(comid){$iot.ranger.devices.get(comid).then(function(data){$timeout(function(){var dataView=data.map(Helper.deviceToView);$scope.searchData.GateList=orderBy(dataView,"Name");$scope.searchData.GateList.unshift({id:"",address:"全部"});$scope.searchData.Gate=$scope.searchData.GateList[0].id})});$iot.communities.loadArch(comid).then(function(data){$timeout(function(){$scope.communityData.queryAddress=data})})};$rootScope.recordBarData=!1;$rootScope.listQuery=!1;$scope.QueryRecord=function(com,gate,event,name,nric,phone,addressBuilding,addressUnit,addressRoom){var validator,i;if(com&&com.length!==0){if(nric&&(validator=new IDValidator,!validator.isValid(nric))){alert("身份证号码格式不正确！");return}for(i=0;i<$scope.adminData.communities.length;i++)if($scope.adminData.communities[i].id===com){$scope.comName=$scope.adminData.communities[i].name;break}var startTimeStr=document.getElementById("startTime").value,endTimeStr=document.getElementById("endTime").value,beginTime=TimeConvert.getTimestamp(startTimeStr),endTime=TimeConvert.getTimestamp(endTimeStr),requestData={beginTime:beginTime,endTime:endTime,gate:gate,community:com,event:event,nric:nric,name:name,phone:phone};addressBuilding&&(requestData.address=addressBuilding.id);addressUnit&&(requestData.address=addressBuilding.id+addressUnit.id);addressRoom&&(requestData.address=addressBuilding.id+addressUnit.id+addressRoom.id);console.log(JSON.parse(JSON.stringify(requestData)));$iot.ranger.events.query(requestData).then(function(){}).catch(function(err){console.log(err)})}};$scope.detail=function(id,eventType){$scope.Imgbase="Ranger/EventImage/"+id+"/"+eventType;$("#detailImage").modal("show")};$scope.enlargeImg=function(){$("#detailModal").addClass("enlargeImg")};$scope.restoreImg=function(){$("#detailModal").removeClass("enlargeImg")};$scope.StatusIds=Helper.statusConstans;$scope.StatusId=undefined;$scope.QueryStatus=function(com,gate,statusid){var i;if(com&&com.length!==0){for(i=0;i<$scope.adminData.communities.length;i++)if($scope.adminData.communities[i].id===com){$scope.comName=$scope.adminData.communities[i].name;break}var startTimeStr=document.getElementById("startTime").value,endTimeStr=document.getElementById("endTime").value,beginTime=TimeConvert.getTimestamp(startTimeStr),endTime=TimeConvert.getTimestamp(endTimeStr),requestData={beginTime:beginTime,endTime:endTime,deviceId:gate,communityId:com,status:statusid};console.log(requestData);$iot.ranger.logs.query(requestData).then(function(){}).catch(function(err){console.log(err)})}}});