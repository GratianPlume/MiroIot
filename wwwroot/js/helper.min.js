var Seq=function(){function n(n,t){this._iter=n;this._state=t}return n.prototype.map=function(t){var i=this,r=function(n){return i._state(function(i){return n(t(i))})};return new n(this._iter,r)},n.prototype.filter=function(t){var i=this,r=function(n){return i._state(function(i){t(i)&&n(i)})};return new n(this._iter,r)},n.prototype.toDict=function(n){var t=Dict.zero(n);return this._iter(this._state(t.tryAdd.bind(t))),console.log(t),t},n.prototype.toArray=function(){var n=[],t=function(t){return n.push(t)};return this._iter(this._state(t)),n},n.prototype.forEach=function(n){this._iter(this._state(n))},n.prototype.reduce=function(n){var t,i=function(i){return t=t===undefined?i:n(t,i)};return this._iter(this._state(i)),t},n.prototype.fold=function(n,t){var i=n,r=function(n){return i=t(i,n)};return this._iter(this._state(r)),i},n.ofArray=function(t){return new n(t.forEach.bind(t),function(n){return n})},n.create=function(t){return new n(t,function(n){return n})},n}(),MainView=function(){function n(){this.chooseCommunity={};this.address={};this.cards=[];this.Fingerprints=[];this.AdvertisingPlans=[];this.AdFiles=[];this.AdchooseCom={};this.queryAddress={}}return n}(),AdminView=function(){function n(){this.name="";this.communities=[];this.manager=Dict.zero(function(n){return n.openid});this.Advertising=[]}return n}(),TimeConvert=function(){function n(){}return n.getTimestamp=function(n){var t=n.replace(/:/g,"-").replace(/[/]/g,"-").replace(/ /g,"-").split("-").map(Number),i;return console.log(n+":"+t),i=new Date(Date.UTC(t[0],t[1]-1,t[2],t[3]-8,t[4],t[5])),Math.floor(i.getTime()/1e3)},n}(),Vadicate=function(){function n(){}return n.blockId=function(n){return n.length!==4?(alert("楼号必须是4位数字，例如：0001"),!1):isNaN(Number(n))?(alert("楼号必须是4位数字，例如：0001"),!1):!0},n.unitId=function(n){return n.length!==2?(alert("单元号必须是2位数字，例如：01"),!1):isNaN(Number(n))?(alert("单元号必须是2位数字，例如：01"),!1):!0},n.flatId=function(n,t){return n.length!==2||t.length!==2?(alert("房间或者楼层号必须是两位数字，例如：01"),!1):isNaN(Number(n))||isNaN(Number(t))?(alert("房间或者楼层号必须是两位数字，例如：01"),!1):Number(n)>Number(t)?(alert("开始房间或者楼号大于结束房间或者楼号！"),!1):!0},n}(),Dict=function(){function n(n,t,i){t===void 0&&(t={});i===void 0&&(i=0);this._keySelector=n;this._length=i;this._item=t}return Object.defineProperty(n.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"$",{get:function(){return this._item},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"$$",{get:function(){var u=function(t,i,r){var u=n.setter(i,r);return function(n){return t(function(t){return u(n(t))})}},t=angular.identity,i=this._item;for(var r in i)i.hasOwnProperty(r)&&(t=u(t,r,i[r]));return t(angular.identity)({})},enumerable:!0,configurable:!0}),n.prototype.containKey=function(n){return this._item[n]!==undefined},n.setter=function(n,t){return function(i){return i[n]=t,i}},n.prototype.addOrUpdate=function(n){var t=this._keySelector(n);this._item[t]===undefined&&this._length++;this._item[t]=n},n.prototype.tryAdd=function(n){var t=this._keySelector(n);return this._item[t]!==undefined?!1:(this._item[t]=n,this._length++,!0)},n.prototype.tryAddHead=function(t){for(var r,u,f,s,i=this._item,e=[],h=[],o=0,c=t;o<c.length;o++)r=c[o],u=this._keySelector(r),i[u]===undefined?e.push([u,r]):h.push(r);var a=function(t,i,r){var u=n.setter(t,i);return function(n){return r(function(t){return n(u(t))})}},v=function(n){var r=angular.identity,t,u;for(t in i)i.hasOwnProperty(t)&&(u=i[t],delete i[t],r=a(t,u,r));return r(n)},y=v(angular.identity);for(f=0,s=e;f<s.length;f++){var l=s[f],u=l[0],r=l[1];i[u]=r}return y(i),this._length+=e.length,h},n.prototype.tryRemove=function(n){var t=this._keySelector(n);return this._item[t]!==undefined?(delete this._item[t],this._length--,!0):!1},n.prototype.tryRemoveKey=function(n){var t=this._item[n];return t!==undefined?(delete this._item[n],this._length--,t):undefined},Object.defineProperty(n.prototype,"first",{get:function(){var n=this._item;for(var t in n)if(n.hasOwnProperty(t))return n[t];return undefined},enumerable:!0,configurable:!0}),n.prototype.toArray=function(n){var r=this._item,t,i;if(n){t=[];for(i in r)r.hasOwnProperty(i)&&t.push(n(this._item[i]));return t}t=[];for(i in r)r.hasOwnProperty(i)&&t.push(this._item[i]);return t},n.prototype.toSortedArray=function(n,t){return this.toArray(t).sort(Helper.comparefn(n))},n.prototype.some=function(n){var i=this._item,t,r;for(t in i)if(i.hasOwnProperty(t)&&(r=this._item[t],n(r)))return!0;return!1},n.prototype.filter=function(t){var u={},f=this._item,e=0,i,r;for(i in f)f.hasOwnProperty(i)&&(r=this._item[i],t(r)&&(u[i]=r,e++));return new n(this._keySelector,u,e)},Object.defineProperty(n.prototype,"copy",{get:function(){var i={},r=this._item,t,u;for(t in r)r.hasOwnProperty(t)&&(u=this._item[t],i[t]=u);return new n(this._keySelector,i,this.length)},enumerable:!0,configurable:!0}),n.zero=function(t){return new n(t)},n.ofArray=function(t,i,r){var u=i||[];return new n(t,n.arrToDicc(t,u,r),u.length)},n.orderByArray=function(t,i,r,u){var f=i.sort(function(n,t){var i=r(n),u=r(t);return i>u?1:i===u?0:-1});return new n(t,n.arrToDicc(t,f,u),i.length)},n.arrToDicc=function(n,t,i){var u={},f,o,e,s,r;if(i){for(f=0,o=t;f<o.length;f++)r=o[f],u[n(r)]=i(r);return u}for(e=0,s=t;e<s.length;e++)r=s[e],u[n(r)]=r;return u},n}(),Helper=function(){function n(){}return n.arrToDic=function(n,t){return Dict.ofArray(function(n){return n.id},n,t)},n.deviceAddressToStr=function(n){if(n!==undefined){var t="000000"+n;return t.slice(-7)}return""},n.deviceToView=function(t){return{id:t.id,address:n.deviceAddressToStr(t.address),password:t.password,communityId:t.communityId,remark:t.remark}},n.toTreeItem=function(n){return[{text:n.name,id:"0",guid:n.guid,nodes:n.buildings.map(function(n){return{text:n.id+"--"+n.name,id:"1",blockNumber:n.id,blockName:n.name,nodes:n.units.map(function(t){return{text:t.id+"--"+t.name,id:"2",blockNumber:n.id,unitNumber:t.id,unitName:t.name,nodes:t.apartments.map(function(i){return{text:i.id,blockNumber:n.id,unitNumber:t.id,roomNumber:i.id,id:"3",guid:i.guid}})}})}})}]},n.permitGenerator=function(n,t){var r=0,i=0;return function(u,f){if(u){if(i<n.length)return f(r,i++);if(++r<t.length)return i=0,f(r,i++)}else if(++r<t.length)return i=0,f(r,i++)}},n.getSeq=function(n){var t=function(t){return angular.forEach(n,t)};return Seq.create(t)},n.val=function(n){return{data:function(t){return t(n),{none:angular.noop}}}},n.none=function(){return{data:function(){return{none:function(n){return n()}}}}},n.unionAuths=function(n){var r,t,u,i;if(!n||n.length===0)return Dict.zero(function(n){return n.deviceId});for(r=Dict.ofArray(function(n){return n.deviceId},n[0].auth),t=1;t<n.length;t++)for(u=n[t],i=0;i<u.auth.length;i++)r.tryAdd(u.auth[i]);return r},n.complementOfIntersect=function(n,t){var f,i,r,u;if(!n||n.length===0)return t.copy;f=n.map(function(n){return Dict.arrToDicc(function(n){return n.deviceId},n.auth)});i=f[0];for(r in i)if(i.hasOwnProperty(r))for(u=1;u<n.length;u++)if(!f[u][r]){delete i[r];continue}return t.filter(function(n){return!i[n.id]})},n.findInArray=function(n,t){for(var r,i=0;i<n.length;i++)if(r=n[i],t(r))return r;return undefined},n.sortedMerge=function(n,t,i,r){for(var u=0,f=0,e=[],h=function(n,t){for(var i=n;i<t.length;i++)e.push(t[i]);return e},l;;){if(n.length===u)return h(f,t);if(t.length===f)return h(u,n);var o=n[u],s=t[f],c=r(o,s);if(c>0){e.push(s);f++;continue}if(c<0){e.push(o);u++;continue}l=i?s:o;e.push(l);u++;f++}},n.comparefn=function(n){return function(t,i){var r=n(t),u=n(i);return r>u?1:r===u?0:-1}},n.fingerConstans=[{id:1,name:"左手拇指"},{id:2,name:"左手食指"},{id:3,name:"左手中指"},{id:4,name:"左手无名指"},{id:5,name:"左手小指"},{id:6,name:"右手拇指"},{id:7,name:"右手食指"},{id:8,name:"右手中指"},{id:9,name:"右手无名指"},{id:10,name:"右手小指"}],n.statusConstans=[{id:undefined,name:"全部"},{id:0,name:"关闭"},{id:1,name:"打开"},{id:2,name:"离线"},{id:3,name:"网络恢复"},{id:4,name:"软件上线"}],n.weekConstans=["日","一","二","三","四","五","六"],n.adminConstans=[{id:1,name:"一级管理员"},{id:2,name:"二级管理员"},{id:3,name:"三级管理员"}],n.eventConstans=[{id:undefined,name:"全部"},{id:0,name:"指纹开锁"},{id:1,name:"呼叫"},{id:2,name:"QQ开锁"},{id:3,name:"IC卡开锁"},{id:4,name:"监视"},{id:5,name:"人脸识别"}],n}(),Community=function(){function n(n){this.id=n}return n}(),Iot=function(){function n(){}return n.connect=function(){return console.log("iot.connect"),n._webClient=WebClient.connect(),n._webClient},n.postForm=function(n,t){return $.ajax({url:n,type:"post",data:t,contentType:!1,cache:!1,processData:!1})},n.getCommunity=function(t){var r=n.comms.$[t],i;return r?r:(i=new Community(t),n.comms.addOrUpdate(i),i)},n.comms=Dict.zero(function(n){return n.id}),n.accounts={login:function(t,i,r){var u={userName:t,password:i,rememberMe:r},f={wsHash:n._webClient.id,ciphertext:encryptedString(n._webClient.rsaKey,JSON.stringify(u))};return $.ajax({type:"POST",url:"/Account/Login",contentType:"application/json; charset=utf-8",data:JSON.stringify(f)})},register:function(n,t,i){var r={userName:n,password:t,inviteCode:i};return $.ajax({type:"POST",url:"Account/Register",contentType:"application/json; charset=utf-8",data:JSON.stringify(r)})},getSubAdmins:function(){return $.get("Account/subAdmins").then(function(n){return Dict.ofArray(function(n){return n.openid},n)})},deleteAdmins:function(n){return $.ajax({type:"POST",url:"Account/DeleteAdmins",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},authCommunities:function(n,t){return $.ajax({type:"POST",url:"Account/AuthCommunity/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})},unAuthCommunities:function(n,t){return $.ajax({type:"POST",url:"Account/ReleaseCommunity/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})},newInviteCode:function(n,t,i){var r={communities:t,level:n,remark:i};return $.ajax({type:"POST",url:"Account/InviteCode",contentType:"application/json; charset=utf-8",data:JSON.stringify(r)})}},n.communities={modify:function(n,t,i){var r={id:n,name:t,remark:i};return $.ajax({type:"POST",url:"Communities/Edit",contentType:"application/json; charset=utf-8",data:JSON.stringify(r)})},"delete":function(n){return $.ajax({type:"POST",url:"Communities/Delete",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},create:function(n,t,i){var r={area:n,name:t,remark:i};return $.ajax({type:"POST",url:"Communities/Create",contentType:"application/json; charset=utf-8",data:JSON.stringify(r)})},loadArch:function(t){return $.get("Communities/LoadArch/"+t).then(function(i){var r=ArchService.ofDoc(i);return n.current=n.getCommunity(t),n.current.arch=r,i})},updateArch:function(n){return $.ajax({type:"POST",url:"Communities/SendArch",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},flatten:function(t,i){return n.comms.$[t].arch.flatTable[i]}},n.manage={changePassword:function(n,t){var i={oldPassword:n,newPassword:t};return $.ajax({type:"POST",url:"Manage/ChangePassword",contentType:"application/json; charset=utf-8",data:JSON.stringify(i)})}},n.persons={sum:function(n){return $.get("Citizen/Folk/"+n).then(function(n){return Dict.ofArray(function(n){return n.nric},n)})},put:function(n){return $.ajax({type:"put",url:"Citizen",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},"delete":function(n,t){var i={id:n,nric:t};return $.ajax({type:"DELETE",url:"Citizen",contentType:"application/json; charset=utf-8",data:JSON.stringify(i)})},get:function(n){return $.get("Citizen/"+n)}},n.devices={items:function(t,i){var r=n.getCommunity(t).devices;r?i(r):$.get("Devices/Folk/"+t).then(function(r){var u=Dict.orderByArray(function(n){return n.id},r,function(n){return n.address});n.getCommunity(t).devices=u;i(u)})},put:function(n){return $.ajax({type:"put",url:"Device",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},"delete":function(n){return $.ajax({type:"DELETE",url:"Device/"+n,contentType:"application/json; charset=utf-8"})}},n.cards={sum:function(n){return $.get("Cards/Folk/"+n)},put:function(n){return $.ajax({type:"put",url:"Cards",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},"delete":function(n){return $.ajax({type:"DELETE",url:"Cards",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"})},issue:function(n,t){return $.ajax({type:"put",url:"Cards/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})},withdraw:function(n,t){return $.ajax({type:"delete",url:"Cards/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})}},n.fingerprints={sum:function(n){return $.get("Fingerprints/Folk/"+n)},get:function(n){return $.get("Fingerprints/"+n)},bind:function(n){return $.ajax({type:"put",url:"Fingerprints/Bind",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},put:function(n){return $.ajax({type:"put",url:"Fingerprints",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})},"delete":function(n){return $.ajax({type:"DELETE",url:"Fingerprints",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"})},issue:function(n,t){return $.ajax({type:"put",url:"Fingerprints/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})},withdraw:function(n,t){return $.ajax({type:"delete",url:"Fingerprints/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})}},n.advertising={files:{sum:function(){return $.get("Advertising/Files")},get:function(n){return $.get("Advertising/Files/"+n)},post:function(t){return n.postForm("/Advertising/Files",t)},put:function(n){return $.ajax({url:"/Advertising/Files",type:"put",data:JSON.stringify(n),contentType:"application/json; charset=utf-8"})}},plans:{get:function(n){return $.get("/Advertising/Plans/"+n)},"delete":function(n){return $.ajax({type:"delete",url:"Advertising/Plans/"+n})},post:function(n,t){return $.ajax({type:"post",url:"Advertising/Plans/"+n,contentType:"application/json; charset=utf-8",data:JSON.stringify(t)})}},devices:{get:function(n){return $.get("Advertising/Devices/"+n)}},issue:{post:function(n){return $.ajax({type:"delete",url:"Advertising/Issue",contentType:"application/json; charset=utf-8",data:JSON.stringify(n)})}}},n.ranger={devices:{get:function(n){return $.get("Ranger/Gates/"+n)}},events:{query:function(t){return $.ajax({type:"post",url:"Ranger/QueryEvents/"+n._webClient.id,data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}},logs:{query:function(t){return $.ajax({type:"post",url:"Ranger/QueryLogs/"+n._webClient.id,data:JSON.stringify(t),contentType:"application/json; charset=utf-8"})}}},n}(),WebClient=function(){function n(n){var t=this,i,r;this._ws=n;i=1e4;r=function(){n.readyState===n.OPEN&&(n.send(JSON.stringify({command:"keepAlive"})),setTimeout(r,i))};n.onopen=function(){t.onopen();n.send(JSON.stringify({command:"getRsaKey"}));setTimeout(r,i)};n.onclose=this.onclose;n.onerror=this.onerror;n.onmessage=function(n){var i=JSON.parse(n.data),r;switch(i.command){case"echoRsaKey":r=i.data;t._wsId=i.wsHash;t._rsaKey=new RsaKeyPair(r.RsaE,"",r.RsaM);break;case"clearEvents":t.onClearEvents();break;case"eventsComplete":t.onEventsCompleted();break;case"clearLogs":t.onClearLogs();break;case"logsComplete":t.onLogsCompleted();break;case"eventItem":t.onEvent(i);break;case"logItem":t.onLog(i)}}}return Object.defineProperty(n.prototype,"id",{get:function(){return this._wsId},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"rsaKey",{get:function(){return this._rsaKey},enumerable:!0,configurable:!0}),n.prototype.bindOpen=function(n){return this.onopen=n,this},n.prototype.bindClose=function(n){return this.onclose=n,this},n.prototype.bindError=function(n){return this.onerror=n,this},n.prototype.bindClearEvents=function(n){return this.onClearEvents=n,this},n.prototype.bindEvent=function(n){return this.onEvent=n,this},n.prototype.bindEventsCompleted=function(n){return this.onEventsCompleted=n,this},n.prototype.bindClearLogs=function(n){return this.onClearLogs=n,this},n.prototype.bindLog=function(n){return this.onLog=n,this},n.prototype.bindLogsCompleted=function(n){return this.onLogsCompleted=n,this},n.connect=function(){if("WebSocket"in window){setMaxDigits(131);var t="ws://"+location.host+"/ws/web",i=new WebSocket(t);return new n(i)}throw"浏览器不支持WebSocket";},n}(),ArchService=function(){function n(){this.flatTable={}}return n.mapUnit=function(n){return function(t){var i={id:t.id,name:t.name},r=t.apartments;return i.items=Helper.arrToDic(r,n(i)),i}},n.mapBlock=function(t){return function(i){var r={id:i.id,name:i.name};return r.items=Helper.arrToDic(i.units,n.mapUnit(t(r))),r}},n.ofDoc=function(t){var i=new n,u=function(n){return function(t){return function(r){return i.flatTable[r.guid]={block:n,unit:t,flat:r},r}}},r={guid:t.guid,name:t.name};return r.items=Helper.arrToDic(t.buildings,n.mapBlock(u)),i.communityX=r,i},n}(),FpService=function(){function n(){var t=this;this.assister=new WebSocket("ws://localhost:5018/");this.assister.onerror=this.onerror;this.assister.onclose=this.onclose;this.assister.onopen=function(){return t.reset()};this.assister.onmessage=function(i){var r=JSON.parse(i.data);if(t._merge){console.log("请按重新采集");return}if(n.isCapture(r)){t._captures.push(r);t.onImage(r.index,"data:image/png;base64,"+r.data.image)}else if(n.isMerge(r))if(r.errcode){t.reset();t.onfail(r.errcode)}else t._merge=r,t.onsuccess();else if(n.isNricRoc(r))t.onNricRoc(r.data)}}return Object.defineProperty(n.prototype,"item",{get:function(){return this._merge?{feature:this._merge.data.feature,image:this._captures[0].data.image,width:this._captures[0].data.width,height:this._captures[0].data.height}:undefined},enumerable:!0,configurable:!0}),n.prototype.reset=function(){this.assister.send(JSON.stringify({command:"reset"}));this._captures=[];this._merge=undefined;this.onreset()},n.prototype.close=function(){this.assister.close()},n.isCapture=function(n){return n.datatype==="fpcapture"},n.isMerge=function(n){return n.datatype==="fpmerge"},n.isNricRoc=function(n){return n.datatype==="nricRoc"},n.create=function(){return new n},n}();